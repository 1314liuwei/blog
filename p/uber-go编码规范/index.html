<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="uber-go/guide 的中文翻译 English Uber Go 语言编码规范 Uber 是一家美国硅谷的科技公司，也是 Go 语言的早期 adopter。其开源了很多 golang 项目，诸如被 Gopher 圈熟知的 zap、jaeger 等。2018 年年末 Uber 将内部的 Go 风格规范 开源到 GitHub，经过一年的积累和更新，该规范已经初具规模，并受到广大 Gopher 的关注。本文是该规范的中文版本。本版本会根据原版实时更新。\n版本 当前更新版本：2021-07-09 版本地址：commit:#130 如果您发现任何更新、问题或改进，请随时 fork 和 PR Please feel free to fork and PR if you find any updates, issues or improvement. 目录 uber-go/guide 的中文翻译 English Uber Go 语言编码规范 版本 目录 介绍 指导原则 指向 interface 的指针 Interface 合理性验证 接收器 (receiver) 与接口 零值 Mutex 是有效的 在边界处拷贝 Slices 和 Maps 接收 Slices 和 Maps 返回 slices 或 maps 使用 defer 释放资源 Channel 的 size 要么是 1，要么是无缓冲的 枚举从 1 开始 使用 time 处理时间 使用 time.Time 表达瞬时时间 使用 time.Duration 表达时间段 对外部系统使用 time.Time 和 time.Duration 错误类型 错误包装 (Error Wrapping) 处理类型断言失败 不要 panic 使用 go.uber.org/atomic 避免可变全局变量 避免在公共结构中嵌入类型 避免使用内置名称 避免使用 init() 追加时优先指定切片容量 主函数退出方式(Exit) 一次性退出 性能 优先使用 strconv 而不是 fmt 避免字符串到字节的转换 指定容器容量 指定Map容量提示 指定切片容量 规范 一致性 相似的声明放在一组 import 分组 包名 函数名 导入别名 函数分组与顺序 减少嵌套 不必要的 else 顶层变量声明 对于未导出的顶层常量和变量，使用_作为前缀 结构体中的嵌入 使用字段名初始化结构体 本地变量声明 nil 是一个有效的 slice 缩小变量作用域 避免参数语义不明确(Avoid Naked Parameters) 使用原始字符串字面值，避免转义 初始化结构体 使用字段名初始化结构 省略结构中的零值字段 对零值结构使用 var 初始化 Struct 引用 初始化 Maps 字符串 string format 命名 Printf 样式的函数 编程模式 表驱动测试 功能选项 Linting Lint Runners Stargazers over time 介绍 样式 (style) 是支配我们代码的惯例。术语样式有点用词不当，因为这些约定涵盖的范围不限于由 gofmt 替我们处理的源文件格式。\n"><title>Uber Go编码规范</title>
<link rel=canonical href=https://wlynxg.github.io/blog/p/uber-go%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/><link rel=stylesheet href=/blog/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Uber Go编码规范"><meta property='og:description' content="uber-go/guide 的中文翻译 English Uber Go 语言编码规范 Uber 是一家美国硅谷的科技公司，也是 Go 语言的早期 adopter。其开源了很多 golang 项目，诸如被 Gopher 圈熟知的 zap、jaeger 等。2018 年年末 Uber 将内部的 Go 风格规范 开源到 GitHub，经过一年的积累和更新，该规范已经初具规模，并受到广大 Gopher 的关注。本文是该规范的中文版本。本版本会根据原版实时更新。\n版本 当前更新版本：2021-07-09 版本地址：commit:#130 如果您发现任何更新、问题或改进，请随时 fork 和 PR Please feel free to fork and PR if you find any updates, issues or improvement. 目录 uber-go/guide 的中文翻译 English Uber Go 语言编码规范 版本 目录 介绍 指导原则 指向 interface 的指针 Interface 合理性验证 接收器 (receiver) 与接口 零值 Mutex 是有效的 在边界处拷贝 Slices 和 Maps 接收 Slices 和 Maps 返回 slices 或 maps 使用 defer 释放资源 Channel 的 size 要么是 1，要么是无缓冲的 枚举从 1 开始 使用 time 处理时间 使用 time.Time 表达瞬时时间 使用 time.Duration 表达时间段 对外部系统使用 time.Time 和 time.Duration 错误类型 错误包装 (Error Wrapping) 处理类型断言失败 不要 panic 使用 go.uber.org/atomic 避免可变全局变量 避免在公共结构中嵌入类型 避免使用内置名称 避免使用 init() 追加时优先指定切片容量 主函数退出方式(Exit) 一次性退出 性能 优先使用 strconv 而不是 fmt 避免字符串到字节的转换 指定容器容量 指定Map容量提示 指定切片容量 规范 一致性 相似的声明放在一组 import 分组 包名 函数名 导入别名 函数分组与顺序 减少嵌套 不必要的 else 顶层变量声明 对于未导出的顶层常量和变量，使用_作为前缀 结构体中的嵌入 使用字段名初始化结构体 本地变量声明 nil 是一个有效的 slice 缩小变量作用域 避免参数语义不明确(Avoid Naked Parameters) 使用原始字符串字面值，避免转义 初始化结构体 使用字段名初始化结构 省略结构中的零值字段 对零值结构使用 var 初始化 Struct 引用 初始化 Maps 字符串 string format 命名 Printf 样式的函数 编程模式 表驱动测试 功能选项 Linting Lint Runners Stargazers over time 介绍 样式 (style) 是支配我们代码的惯例。术语样式有点用词不当，因为这些约定涵盖的范围不限于由 gofmt 替我们处理的源文件格式。\n"><meta property='og:url' content='https://wlynxg.github.io/blog/p/uber-go%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/'><meta property='og:site_name' content="Wlynxg's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2023-03-02T09:55:21+08:00'><meta property='article:modified_time' content='2023-03-02T09:55:21+08:00'><meta name=twitter:title content="Uber Go编码规范"><meta name=twitter:description content="uber-go/guide 的中文翻译 English Uber Go 语言编码规范 Uber 是一家美国硅谷的科技公司，也是 Go 语言的早期 adopter。其开源了很多 golang 项目，诸如被 Gopher 圈熟知的 zap、jaeger 等。2018 年年末 Uber 将内部的 Go 风格规范 开源到 GitHub，经过一年的积累和更新，该规范已经初具规模，并受到广大 Gopher 的关注。本文是该规范的中文版本。本版本会根据原版实时更新。\n版本 当前更新版本：2021-07-09 版本地址：commit:#130 如果您发现任何更新、问题或改进，请随时 fork 和 PR Please feel free to fork and PR if you find any updates, issues or improvement. 目录 uber-go/guide 的中文翻译 English Uber Go 语言编码规范 版本 目录 介绍 指导原则 指向 interface 的指针 Interface 合理性验证 接收器 (receiver) 与接口 零值 Mutex 是有效的 在边界处拷贝 Slices 和 Maps 接收 Slices 和 Maps 返回 slices 或 maps 使用 defer 释放资源 Channel 的 size 要么是 1，要么是无缓冲的 枚举从 1 开始 使用 time 处理时间 使用 time.Time 表达瞬时时间 使用 time.Duration 表达时间段 对外部系统使用 time.Time 和 time.Duration 错误类型 错误包装 (Error Wrapping) 处理类型断言失败 不要 panic 使用 go.uber.org/atomic 避免可变全局变量 避免在公共结构中嵌入类型 避免使用内置名称 避免使用 init() 追加时优先指定切片容量 主函数退出方式(Exit) 一次性退出 性能 优先使用 strconv 而不是 fmt 避免字符串到字节的转换 指定容器容量 指定Map容量提示 指定切片容量 规范 一致性 相似的声明放在一组 import 分组 包名 函数名 导入别名 函数分组与顺序 减少嵌套 不必要的 else 顶层变量声明 对于未导出的顶层常量和变量，使用_作为前缀 结构体中的嵌入 使用字段名初始化结构体 本地变量声明 nil 是一个有效的 slice 缩小变量作用域 避免参数语义不明确(Avoid Naked Parameters) 使用原始字符串字面值，避免转义 初始化结构体 使用字段名初始化结构 省略结构中的零值字段 对零值结构使用 var 初始化 Struct 引用 初始化 Maps 字符串 string format 命名 Printf 样式的函数 编程模式 表驱动测试 功能选项 Linting Lint Runners Stargazers over time 介绍 样式 (style) 是支配我们代码的惯例。术语样式有点用词不当，因为这些约定涵盖的范围不限于由 gofmt 替我们处理的源文件格式。\n"><link rel="shortcut icon" href=/blog/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/><img src=/blog/img/file_hu6889846174828548036.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🐂</span></figure><div class=site-meta><h1 class=site-name><a href=/blog>Wlynxg's Blog</a></h1><h2 class=site-description>The harder, ther luckier!</h2></div></header><ol class=menu-social><li><a href=https://github.com/wlynxg target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:liuauthor@foxmail.com target=_blank title=Mail rel=me><svg t="1730733819354" class="icon" viewBox="0 0 1024 1024" p-id="3570" width="24" height="24"><path d="M942.08 200.704s-1.024.0.0.0c-1.024-2.048-1.024-4.096-2.048-6.144-1.024-1.024-2.048-3.072-3.072-4.096l-1.024-1.024-1.024-1.024c-1.024-1.024-2.048-2.048-4.096-2.048h-1.024c-2.048-1.024-3.072-1.024-5.12-1.024h-1.024C788.48 163.84 649.216 153.6 512 153.6s-276.48 10.24-412.672 30.72h-1.024c-2.048.0-3.072 1.024-5.12 1.024H92.16c-1.024 1.024-3.072 1.024-4.096 2.048l-1.024 1.024-1.024 1.024c-1.024 1.024-2.048 2.048-3.072 4.096v1.024c-1.024 2.048-1.024 3.072-2.048 5.12C61.44 304.128 51.2 408.576 51.2 512s10.24 207.872 30.72 311.296c2.048 8.192 8.192 15.36 17.408 16.384C235.52 860.16 374.784 870.4 512 870.4s276.48-10.24 412.672-30.72c8.192-1.024 15.36-8.192 17.408-16.384C962.56 719.872 972.8 615.424 972.8 512s-10.24-207.872-30.72-311.296zm-60.416 19.456c-44.032 50.176-96.256 97.28-156.672 142.336C654.336 415.744 582.656 457.728 512 489.472c-77.824-36.864-148.48-78.848-212.992-126.976-56.32-41.984-108.544-90.112-156.672-142.336 122.88-17.408 246.784-25.6 369.664-25.6s246.784 8.192 369.664 25.6zm22.528 580.608C774.144 820.224 642.048 829.44 512 829.44s-262.144-9.216-392.192-28.672C101.376 705.536 92.16 608.256 92.16 512c0-87.04 8.192-175.104 22.528-262.144 48.128 53.248 102.4 102.4 159.744 145.408 69.632 52.224 144.384 96.256 229.376 135.168 3.072 1.024 6.144 2.048 8.192 2.048 3.072.0 5.12-1.024 8.192-2.048 76.8-32.768 153.6-78.848 229.376-135.168 60.416-46.08 114.688-94.208 159.744-144.384C924.672 337.92 931.84 424.96 931.84 512c0 96.256-9.216 193.536-27.648 288.768z" p-id="3571" fill="#707070"/></svg></a></li><li><a href=/blog/index.xml target=_blank title=RSS rel=me><svg t="1730718821658" class="icon" viewBox="0 0 1024 1024" p-id="21619" width="24" height="24"><path d="M554.666667 896C529.066667 896 512 878.933333 512 853.333333 512 665.6 358.4 512 170.666667 512 145.066667 512 128 494.933333 128 469.333333s17.066667-42.666667 42.666667-42.666666c234.666667.0 426.666667 192 426.666666 426.666666.0 25.6-17.066667 42.666667-42.666666 42.666667z" p-id="21620" fill="#707070"/><path d="M853.333333 896c-25.6.0-42.666667-17.066667-42.666666-42.666667.0-354.133333-285.866667-640-640-640-25.6.0-42.666667-17.066667-42.666667-42.666666S145.066667 128 170.666667 128C571.733334 128 896 452.266667 896 853.333333 896 878.933333 878.933333 896 853.333333 896z" p-id="21621" fill="#707070"/><path d="M213.333333 810.666667m-85.333333.0a85.333333 85.333333.0 10170.666667.0 85.333333 85.333333.0 10-170.666667.0z" p-id="21622" fill="#707070"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/blog/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/blog/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/blog/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/blog/plan/><svg t="1730733517435" class="icon" viewBox="0 0 1024 1024" p-id="1581" width="24" height="24"><path d="M874.24 1013.76H143.36a94.72 94.72.0 01-94.72-94.72V188.16a94.72 94.72.0 0194.72-94.72h730.88a95.36 95.36.0 0194.72 94.72v730.88a94.72 94.72.0 01-94.72 94.72zM143.36 156.8a31.36 31.36.0 00-32 31.36v730.88a32 32 0 0032 32h730.88a32 32 0 0031.36-32V188.16a31.36 31.36.0 00-31.36-31.36z" fill="#707070" p-id="1582"/><path d="M926.08 399.36h-832a32 32 0 010-64h832a32 32 0 110 64zM339.84 273.28a31.36 31.36.0 01-31.36-32V39.04a31.36 31.36.0 0131.36-32 32 32 0 0132 32v202.24a32 32 0 01-32 32zm337.28.0a31.36 31.36.0 01-31.36-32V39.04a31.36 31.36.0 1164 0v202.24a31.36 31.36.0 01-32.64 32zM444.16 841.6a33.92 33.92.0 01-23.04-9.6l-128-138.24a32 32 0 1146.08-43.52L448 768l280.32-279.68a30.72 30.72.0 0144.8.0 31.36 31.36.0 010 44.16L466.56 832a32 32 0 01-22.4 9.6z" fill="#707070" p-id="1583"/></svg>
<span>Plan</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#uber-goguidehttpsgithubcomuber-goguide-的中文翻译><a href=https://github.com/uber-go/guide>uber-go/guide</a> 的中文翻译</a></li><li><a href=#englishhttpsgithubcomuber-goguideblobmasterstylemd><a href=https://github.com/uber-go/guide/blob/master/style.md>English</a></a></li><li><a href=#uber-go-语言编码规范>Uber Go 语言编码规范</a></li><li><a href=#版本>版本</a></li><li><a href=#目录>目录</a></li><li><a href=#介绍>介绍</a></li><li><a href=#指导原则>指导原则</a><ol><li><a href=#指向-interface-的指针>指向 interface 的指针</a></li><li><a href=#interface-合理性验证>Interface 合理性验证</a></li><li><a href=#接收器-receiver-与接口>接收器 (receiver) 与接口</a></li><li><a href=#零值-mutex-是有效的>零值 Mutex 是有效的</a></li><li><a href=#在边界处拷贝-slices-和-maps>在边界处拷贝 Slices 和 Maps</a><ol><li><a href=#接收-slices-和-maps>接收 Slices 和 Maps</a></li><li><a href=#返回-slices-或-maps>返回 slices 或 maps</a></li></ol></li><li><a href=#使用-defer-释放资源>使用 defer 释放资源</a></li><li><a href=#channel-的-size-要么是-1要么是无缓冲的>Channel 的 size 要么是 1，要么是无缓冲的</a></li><li><a href=#枚举从-1-开始>枚举从 1 开始</a></li><li><a href=#使用-time-处理时间>使用 time 处理时间</a><ol><li><a href=#使用-timetime-表达瞬时时间>使用 <code>time.Time</code> 表达瞬时时间</a></li><li><a href=#使用-timeduration-表达时间段>使用 <code>time.Duration</code> 表达时间段</a></li><li><a href=#对外部系统使用-timetime-和-timeduration>对外部系统使用 <code>time.Time</code> 和 <code>time.Duration</code></a></li></ol></li><li><a href=#错误类型>错误类型</a></li><li><a href=#错误包装-error-wrapping>错误包装 (Error Wrapping)</a></li><li><a href=#处理类型断言失败>处理类型断言失败</a></li><li><a href=#不要-panic>不要 panic</a></li><li><a href=#使用-gouberorgatomic>使用 go.uber.org/atomic</a></li><li><a href=#避免可变全局变量>避免可变全局变量</a></li><li><a href=#避免在公共结构中嵌入类型>避免在公共结构中嵌入类型</a></li><li><a href=#避免使用内置名称>避免使用内置名称</a></li><li><a href=#避免使用-init>避免使用 <code>init()</code></a></li><li><a href=#追加时优先指定切片容量>追加时优先指定切片容量</a></li><li><a href=#主函数退出方式exit>主函数退出方式(Exit)</a><ol><li><a href=#一次性退出>一次性退出</a></li></ol></li></ol></li><li><a href=#性能>性能</a><ol><li><a href=#优先使用-strconv-而不是-fmt>优先使用 strconv 而不是 fmt</a></li><li><a href=#避免字符串到字节的转换>避免字符串到字节的转换</a></li><li><a href=#指定容器容量>指定容器容量</a><ol><li><a href=#指定map容量提示>指定Map容量提示</a></li><li><a href=#指定切片容量>指定切片容量</a></li></ol></li></ol></li><li><a href=#规范>规范</a><ol><li><a href=#一致性>一致性</a></li><li><a href=#相似的声明放在一组>相似的声明放在一组</a></li><li><a href=#import-分组>import 分组</a></li><li><a href=#包名>包名</a></li><li><a href=#函数名>函数名</a></li><li><a href=#导入别名>导入别名</a></li><li><a href=#函数分组与顺序>函数分组与顺序</a></li><li><a href=#减少嵌套>减少嵌套</a></li><li><a href=#不必要的-else>不必要的 else</a></li><li><a href=#顶层变量声明>顶层变量声明</a></li><li><a href=#对于未导出的顶层常量和变量使用_作为前缀>对于未导出的顶层常量和变量，使用_作为前缀</a></li><li><a href=#结构体中的嵌入>结构体中的嵌入</a></li><li><a href=#使用字段名初始化结构体>使用字段名初始化结构体</a></li><li><a href=#本地变量声明>本地变量声明</a></li><li><a href=#nil-是一个有效的-slice>nil 是一个有效的 slice</a></li><li><a href=#缩小变量作用域>缩小变量作用域</a></li><li><a href=#避免参数语义不明确avoid-naked-parameters>避免参数语义不明确(Avoid Naked Parameters)</a></li><li><a href=#使用原始字符串字面值避免转义>使用原始字符串字面值，避免转义</a></li><li><a href=#初始化结构体>初始化结构体</a><ol><li><a href=#使用字段名初始化结构>使用字段名初始化结构</a></li><li><a href=#省略结构中的零值字段>省略结构中的零值字段</a></li><li><a href=#对零值结构使用-var>对零值结构使用 <code>var</code></a></li><li><a href=#初始化-struct-引用>初始化 Struct 引用</a></li></ol></li><li><a href=#初始化-maps>初始化 Maps</a></li><li><a href=#字符串-string-format>字符串 string format</a></li><li><a href=#命名-printf-样式的函数>命名 Printf 样式的函数</a></li></ol></li><li><a href=#编程模式>编程模式</a><ol><li><a href=#表驱动测试>表驱动测试</a></li><li><a href=#功能选项>功能选项</a></li></ol></li><li><a href=#linting>Linting</a><ol><li><a href=#lint-runners>Lint Runners</a></li></ol></li><li><a href=#stargazers-over-time>Stargazers over time</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/blog/categories/go/ style=background-color:#79d4fd;color:#fff>Go</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/uber-go%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/>Uber Go编码规范</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 02, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 28 分钟</time></div></footer></div></header><section class=article-content><h2 id=uber-goguidehttpsgithubcomuber-goguide-的中文翻译><a class=link href=https://github.com/uber-go/guide target=_blank rel=noopener>uber-go/guide</a> 的中文翻译</h2><h2 id=englishhttpsgithubcomuber-goguideblobmasterstylemd><a class=link href=https://github.com/uber-go/guide/blob/master/style.md target=_blank rel=noopener>English</a></h2><h2 id=uber-go-语言编码规范>Uber Go 语言编码规范</h2><p><a class=link href=https://www.uber.com/ target=_blank rel=noopener>Uber</a> 是一家美国硅谷的科技公司，也是 Go 语言的早期 adopter。其开源了很多 golang 项目，诸如被 Gopher 圈熟知的 <a class=link href=https://github.com/uber-go/zap target=_blank rel=noopener>zap</a>、<a class=link href=https://github.com/jaegertracing/jaeger target=_blank rel=noopener>jaeger</a> 等。2018 年年末 Uber 将内部的 <a class=link href=https://github.com/uber-go/guide target=_blank rel=noopener>Go 风格规范</a> 开源到 GitHub，经过一年的积累和更新，该规范已经初具规模，并受到广大 Gopher 的关注。本文是该规范的中文版本。本版本会根据原版实时更新。</p><h2 id=版本>版本</h2><ul><li>当前更新版本：2021-07-09 版本地址：<a class=link href=https://github.com/uber-go/guide/commit/b8745282405323881e13cd122d5222316a815349 target=_blank rel=noopener>commit:#130</a></li><li>如果您发现任何更新、问题或改进，请随时 fork 和 PR</li><li>Please feel free to fork and PR if you find any updates, issues or improvement.</li></ul><h2 id=目录>目录</h2><ul><li><a class=link href=#uber-goguide-%e7%9a%84%e4%b8%ad%e6%96%87%e7%bf%bb%e8%af%91>uber-go/guide 的中文翻译</a></li><li><a class=link href=#english>English</a></li><li><a class=link href=#uber-go-%e8%af%ad%e8%a8%80%e7%bc%96%e7%a0%81%e8%a7%84%e8%8c%83>Uber Go 语言编码规范</a></li><li><a class=link href=#%e7%89%88%e6%9c%ac>版本</a></li><li><a class=link href=#%e7%9b%ae%e5%bd%95>目录</a></li><li><a class=link href=#%e4%bb%8b%e7%bb%8d>介绍</a></li><li><a class=link href=#%e6%8c%87%e5%af%bc%e5%8e%9f%e5%88%99>指导原则</a><ul><li><a class=link href=#%e6%8c%87%e5%90%91-interface-%e7%9a%84%e6%8c%87%e9%92%88>指向 interface 的指针</a></li><li><a class=link href=#interface-%e5%90%88%e7%90%86%e6%80%a7%e9%aa%8c%e8%af%81>Interface 合理性验证</a></li><li><a class=link href=#%e6%8e%a5%e6%94%b6%e5%99%a8-receiver-%e4%b8%8e%e6%8e%a5%e5%8f%a3>接收器 (receiver) 与接口</a></li><li><a class=link href=#%e9%9b%b6%e5%80%bc-mutex-%e6%98%af%e6%9c%89%e6%95%88%e7%9a%84>零值 Mutex 是有效的</a></li><li><a class=link href=#%e5%9c%a8%e8%be%b9%e7%95%8c%e5%a4%84%e6%8b%b7%e8%b4%9d-slices-%e5%92%8c-maps>在边界处拷贝 Slices 和 Maps</a><ul><li><a class=link href=#%e6%8e%a5%e6%94%b6-slices-%e5%92%8c-maps>接收 Slices 和 Maps</a></li><li><a class=link href=#%e8%bf%94%e5%9b%9e-slices-%e6%88%96-maps>返回 slices 或 maps</a></li></ul></li><li><a class=link href=#%e4%bd%bf%e7%94%a8-defer-%e9%87%8a%e6%94%be%e8%b5%84%e6%ba%90>使用 defer 释放资源</a></li><li><a class=link href=#channel-%e7%9a%84-size-%e8%a6%81%e4%b9%88%e6%98%af-1%e8%a6%81%e4%b9%88%e6%98%af%e6%97%a0%e7%bc%93%e5%86%b2%e7%9a%84>Channel 的 size 要么是 1，要么是无缓冲的</a></li><li><a class=link href=#%e6%9e%9a%e4%b8%be%e4%bb%8e-1-%e5%bc%80%e5%a7%8b>枚举从 1 开始</a></li><li><a class=link href=#%e4%bd%bf%e7%94%a8-time-%e5%a4%84%e7%90%86%e6%97%b6%e9%97%b4>使用 time 处理时间</a><ul><li><a class=link href=#%e4%bd%bf%e7%94%a8-timetime-%e8%a1%a8%e8%be%be%e7%9e%ac%e6%97%b6%e6%97%b6%e9%97%b4>使用 <code>time.Time</code> 表达瞬时时间</a></li><li><a class=link href=#%e4%bd%bf%e7%94%a8-timeduration-%e8%a1%a8%e8%be%be%e6%97%b6%e9%97%b4%e6%ae%b5>使用 <code>time.Duration</code> 表达时间段</a></li><li><a class=link href=#%e5%af%b9%e5%a4%96%e9%83%a8%e7%b3%bb%e7%bb%9f%e4%bd%bf%e7%94%a8-timetime-%e5%92%8c-timeduration>对外部系统使用 <code>time.Time</code> 和 <code>time.Duration</code></a></li></ul></li><li><a class=link href=#%e9%94%99%e8%af%af%e7%b1%bb%e5%9e%8b>错误类型</a></li><li><a class=link href=#%e9%94%99%e8%af%af%e5%8c%85%e8%a3%85-error-wrapping>错误包装 (Error Wrapping)</a></li><li><a class=link href=#%e5%a4%84%e7%90%86%e7%b1%bb%e5%9e%8b%e6%96%ad%e8%a8%80%e5%a4%b1%e8%b4%a5>处理类型断言失败</a></li><li><a class=link href=#%e4%b8%8d%e8%a6%81-panic>不要 panic</a></li><li><a class=link href=#%e4%bd%bf%e7%94%a8-gouberorgatomic>使用 go.uber.org/atomic</a></li><li><a class=link href=#%e9%81%bf%e5%85%8d%e5%8f%af%e5%8f%98%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f>避免可变全局变量</a></li><li><a class=link href=#%e9%81%bf%e5%85%8d%e5%9c%a8%e5%85%ac%e5%85%b1%e7%bb%93%e6%9e%84%e4%b8%ad%e5%b5%8c%e5%85%a5%e7%b1%bb%e5%9e%8b>避免在公共结构中嵌入类型</a></li><li><a class=link href=#%e9%81%bf%e5%85%8d%e4%bd%bf%e7%94%a8%e5%86%85%e7%bd%ae%e5%90%8d%e7%a7%b0>避免使用内置名称</a></li><li><a class=link href=#%e9%81%bf%e5%85%8d%e4%bd%bf%e7%94%a8-init>避免使用 <code>init()</code></a></li><li><a class=link href=#%e8%bf%bd%e5%8a%a0%e6%97%b6%e4%bc%98%e5%85%88%e6%8c%87%e5%ae%9a%e5%88%87%e7%89%87%e5%ae%b9%e9%87%8f>追加时优先指定切片容量</a></li><li><a class=link href=#%e4%b8%bb%e5%87%bd%e6%95%b0%e9%80%80%e5%87%ba%e6%96%b9%e5%bc%8fexit>主函数退出方式(Exit)</a><ul><li><a class=link href=#%e4%b8%80%e6%ac%a1%e6%80%a7%e9%80%80%e5%87%ba>一次性退出</a></li></ul></li></ul></li><li><a class=link href=#%e6%80%a7%e8%83%bd>性能</a><ul><li><a class=link href=#%e4%bc%98%e5%85%88%e4%bd%bf%e7%94%a8-strconv-%e8%80%8c%e4%b8%8d%e6%98%af-fmt>优先使用 strconv 而不是 fmt</a></li><li><a class=link href=#%e9%81%bf%e5%85%8d%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%88%b0%e5%ad%97%e8%8a%82%e7%9a%84%e8%bd%ac%e6%8d%a2>避免字符串到字节的转换</a></li><li><a class=link href=#%e6%8c%87%e5%ae%9a%e5%ae%b9%e5%99%a8%e5%ae%b9%e9%87%8f>指定容器容量</a><ul><li><a class=link href=#%e6%8c%87%e5%ae%9amap%e5%ae%b9%e9%87%8f%e6%8f%90%e7%a4%ba>指定Map容量提示</a></li><li><a class=link href=#%e6%8c%87%e5%ae%9a%e5%88%87%e7%89%87%e5%ae%b9%e9%87%8f>指定切片容量</a></li></ul></li></ul></li><li><a class=link href=#%e8%a7%84%e8%8c%83>规范</a><ul><li><a class=link href=#%e4%b8%80%e8%87%b4%e6%80%a7>一致性</a></li><li><a class=link href=#%e7%9b%b8%e4%bc%bc%e7%9a%84%e5%a3%b0%e6%98%8e%e6%94%be%e5%9c%a8%e4%b8%80%e7%bb%84>相似的声明放在一组</a></li><li><a class=link href=#import-%e5%88%86%e7%bb%84>import 分组</a></li><li><a class=link href=#%e5%8c%85%e5%90%8d>包名</a></li><li><a class=link href=#%e5%87%bd%e6%95%b0%e5%90%8d>函数名</a></li><li><a class=link href=#%e5%af%bc%e5%85%a5%e5%88%ab%e5%90%8d>导入别名</a></li><li><a class=link href=#%e5%87%bd%e6%95%b0%e5%88%86%e7%bb%84%e4%b8%8e%e9%a1%ba%e5%ba%8f>函数分组与顺序</a></li><li><a class=link href=#%e5%87%8f%e5%b0%91%e5%b5%8c%e5%a5%97>减少嵌套</a></li><li><a class=link href=#%e4%b8%8d%e5%bf%85%e8%a6%81%e7%9a%84-else>不必要的 else</a></li><li><a class=link href=#%e9%a1%b6%e5%b1%82%e5%8f%98%e9%87%8f%e5%a3%b0%e6%98%8e>顶层变量声明</a></li><li><a class=link href=#%e5%af%b9%e4%ba%8e%e6%9c%aa%e5%af%bc%e5%87%ba%e7%9a%84%e9%a1%b6%e5%b1%82%e5%b8%b8%e9%87%8f%e5%92%8c%e5%8f%98%e9%87%8f%e4%bd%bf%e7%94%a8_%e4%bd%9c%e4%b8%ba%e5%89%8d%e7%bc%80>对于未导出的顶层常量和变量，使用_作为前缀</a></li><li><a class=link href=#%e7%bb%93%e6%9e%84%e4%bd%93%e4%b8%ad%e7%9a%84%e5%b5%8c%e5%85%a5>结构体中的嵌入</a></li><li><a class=link href=#%e4%bd%bf%e7%94%a8%e5%ad%97%e6%ae%b5%e5%90%8d%e5%88%9d%e5%a7%8b%e5%8c%96%e7%bb%93%e6%9e%84%e4%bd%93>使用字段名初始化结构体</a></li><li><a class=link href=#%e6%9c%ac%e5%9c%b0%e5%8f%98%e9%87%8f%e5%a3%b0%e6%98%8e>本地变量声明</a></li><li><a class=link href=#nil-%e6%98%af%e4%b8%80%e4%b8%aa%e6%9c%89%e6%95%88%e7%9a%84-slice>nil 是一个有效的 slice</a></li><li><a class=link href=#%e7%bc%a9%e5%b0%8f%e5%8f%98%e9%87%8f%e4%bd%9c%e7%94%a8%e5%9f%9f>缩小变量作用域</a></li><li><a class=link href=#%e9%81%bf%e5%85%8d%e5%8f%82%e6%95%b0%e8%af%ad%e4%b9%89%e4%b8%8d%e6%98%8e%e7%a1%aeavoid-naked-parameters>避免参数语义不明确(Avoid Naked Parameters)</a></li><li><a class=link href=#%e4%bd%bf%e7%94%a8%e5%8e%9f%e5%a7%8b%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%ad%97%e9%9d%a2%e5%80%bc%e9%81%bf%e5%85%8d%e8%bd%ac%e4%b9%89>使用原始字符串字面值，避免转义</a></li><li><a class=link href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%bb%93%e6%9e%84%e4%bd%93>初始化结构体</a><ul><li><a class=link href=#%e4%bd%bf%e7%94%a8%e5%ad%97%e6%ae%b5%e5%90%8d%e5%88%9d%e5%a7%8b%e5%8c%96%e7%bb%93%e6%9e%84>使用字段名初始化结构</a></li><li><a class=link href=#%e7%9c%81%e7%95%a5%e7%bb%93%e6%9e%84%e4%b8%ad%e7%9a%84%e9%9b%b6%e5%80%bc%e5%ad%97%e6%ae%b5>省略结构中的零值字段</a></li><li><a class=link href=#%e5%af%b9%e9%9b%b6%e5%80%bc%e7%bb%93%e6%9e%84%e4%bd%bf%e7%94%a8-var>对零值结构使用 <code>var</code></a></li><li><a class=link href=#%e5%88%9d%e5%a7%8b%e5%8c%96-struct-%e5%bc%95%e7%94%a8>初始化 Struct 引用</a></li></ul></li><li><a class=link href=#%e5%88%9d%e5%a7%8b%e5%8c%96-maps>初始化 Maps</a></li><li><a class=link href=#%e5%ad%97%e7%ac%a6%e4%b8%b2-string-format>字符串 string format</a></li><li><a class=link href=#%e5%91%bd%e5%90%8d-printf-%e6%a0%b7%e5%bc%8f%e7%9a%84%e5%87%bd%e6%95%b0>命名 Printf 样式的函数</a></li></ul></li><li><a class=link href=#%e7%bc%96%e7%a8%8b%e6%a8%a1%e5%bc%8f>编程模式</a><ul><li><a class=link href=#%e8%a1%a8%e9%a9%b1%e5%8a%a8%e6%b5%8b%e8%af%95>表驱动测试</a></li><li><a class=link href=#%e5%8a%9f%e8%83%bd%e9%80%89%e9%a1%b9>功能选项</a></li></ul></li><li><a class=link href=#linting>Linting</a><ul><li><a class=link href=#lint-runners>Lint Runners</a></li></ul></li><li><a class=link href=#stargazers-over-time>Stargazers over time</a></li></ul><h2 id=介绍>介绍</h2><p>样式 (style) 是支配我们代码的惯例。术语<code>样式</code>有点用词不当，因为这些约定涵盖的范围不限于由 gofmt 替我们处理的源文件格式。</p><p>本指南的目的是通过详细描述在 Uber 编写 Go 代码的注意事项来管理这种复杂性。这些规则的存在是为了使代码库易于管理，同时仍然允许工程师更有效地使用 Go 语言功能。</p><p>该指南最初由 <a class=link href=https://github.com/prashantv target=_blank rel=noopener>Prashant Varanasi</a> 和 <a class=link href=https://github.com/nomis52 target=_blank rel=noopener>Simon Newton</a> 编写，目的是使一些同事能快速使用 Go。多年来，该指南已根据其他人的反馈进行了修改。</p><p>本文档记录了我们在 Uber 遵循的 Go 代码中的惯用约定。其中许多是 Go 的通用准则，而其他扩展准则依赖于下面外部的指南：</p><ol><li><a class=link href=https://golang.org/doc/effective_go.html target=_blank rel=noopener>Effective Go</a></li><li><a class=link href=https://github.com/golang/go/wiki/CommonMistakes target=_blank rel=noopener>Go Common Mistakes</a></li><li><a class=link href=https://github.com/golang/go/wiki/CodeReviewComments target=_blank rel=noopener>Go Code Review Comments</a></li></ol><p>所有代码都应该通过<code>golint</code>和<code>go vet</code>的检查并无错误。我们建议您将编辑器设置为：</p><ul><li>保存时运行 <code>goimports</code></li><li>运行 <code>golint</code> 和 <code>go vet</code> 检查错误</li></ul><p>您可以在以下 Go 编辑器工具支持页面中找到更为详细的信息：
<a class=link href=https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins target=_blank rel=noopener>https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins</a></p><h2 id=指导原则>指导原则</h2><h3 id=指向-interface-的指针>指向 interface 的指针</h3><p>您几乎不需要指向接口类型的指针。您应该将接口作为值进行传递，在这样的传递过程中，实质上传递的底层数据仍然可以是指针。</p><p>接口实质上在底层用两个字段表示：</p><ol><li>一个指向某些特定类型信息的指针。您可以将其视为"type"。</li><li>数据指针。如果存储的数据是指针，则直接存储。如果存储的数据是一个值，则存储指向该值的指针。</li></ol><p>如果希望接口方法修改基础数据，则必须使用指针传递(将对象指针赋值给接口变量)。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>F</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>f</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>S1</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>S1</span><span class=p>)</span> <span class=nf>f</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>S2</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>S2</span><span class=p>)</span> <span class=nf>f</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// f1.f()无法修改底层数据
</span></span></span><span class=line><span class=cl><span class=c1>// f2.f() 可以修改底层数据,给接口变量f2赋值时使用的是对象指针
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>f1</span> <span class=nx>F</span> <span class=p>=</span> <span class=nx>S1</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>f2</span> <span class=nx>F</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>S2</span><span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=interface-合理性验证>Interface 合理性验证</h3><p>在编译时验证接口的符合性。这包括：</p><ul><li>将实现特定接口的导出类型作为接口API 的一部分进行检查</li><li>实现同一接口的(导出和非导出)类型属于实现类型的集合</li><li>任何违反接口合理性检查的场景,都会终止编译,并通知给用户</li></ul><p>补充:上面3条是编译器对接口的检查机制,
大体意思是错误使用接口会在编译期报错.
所以可以利用这个机制让部分问题在编译期暴露.</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 如果Handler没有实现http.Handler,会在运行时报错
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Handler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>Handler</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Handler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 用于触发编译期的接口的合理性检查机制
</span></span></span><span class=line><span class=cl><span class=c1>// 如果Handler没有实现http.Handler,会在编译期报错
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>_</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>=</span> <span class=p>(</span><span class=o>*</span><span class=nx>Handler</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>Handler</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>如果 <code>*Handler</code> 与 <code>http.Handler</code> 的接口不匹配,
那么语句 <code>var _ http.Handler = (*Handler)(nil)</code> 将无法编译通过.</p><p>赋值的右边应该是断言类型的零值。
对于指针类型（如 <code>*Handler</code>）、切片和映射，这是 <code>nil</code>；
对于结构类型，这是空结构。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>LogHandler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>h</span>   <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span> <span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>=</span> <span class=nx>LogHandler</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=nx>LogHandler</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=接收器-receiver-与接口>接收器 (receiver) 与接口</h3><p>使用值接收器的方法既可以通过值调用，也可以通过指针调用。</p><p>带指针接收器的方法只能通过指针或 <a class=link href=https://golang.org/ref/spec#Method_values target=_blank rel=noopener>addressable values</a>调用.</p><p>例如，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>S</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>S</span><span class=p>)</span> <span class=nf>Read</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>S</span><span class=p>)</span> <span class=nf>Write</span><span class=p>(</span><span class=nx>str</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>data</span> <span class=p>=</span> <span class=nx>str</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>sVals</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=nx>S</span><span class=p>{</span><span class=mi>1</span><span class=p>:</span> <span class=p>{</span><span class=s>&#34;A&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 你只能通过值调用 Read
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>sVals</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nf>Read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 这不能编译通过：
</span></span></span><span class=line><span class=cl><span class=c1>//  sVals[1].Write(&#34;test&#34;)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>sPtrs</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=o>*</span><span class=nx>S</span><span class=p>{</span><span class=mi>1</span><span class=p>:</span> <span class=p>{</span><span class=s>&#34;A&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 通过指针既可以调用 Read，也可以调用 Write 方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>sPtrs</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nf>Read</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>sPtrs</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nf>Write</span><span class=p>(</span><span class=s>&#34;test&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>类似的,即使方法有了值接收器,也同样可以用指针接收器来满足接口.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>F</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>f</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>S1</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>S1</span><span class=p>)</span> <span class=nf>f</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>S2</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>S2</span><span class=p>)</span> <span class=nf>f</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>s1Val</span> <span class=o>:=</span> <span class=nx>S1</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nx>s1Ptr</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>S1</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nx>s2Val</span> <span class=o>:=</span> <span class=nx>S2</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nx>s2Ptr</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>S2</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>i</span> <span class=nx>F</span>
</span></span><span class=line><span class=cl><span class=nx>i</span> <span class=p>=</span> <span class=nx>s1Val</span>
</span></span><span class=line><span class=cl><span class=nx>i</span> <span class=p>=</span> <span class=nx>s1Ptr</span>
</span></span><span class=line><span class=cl><span class=nx>i</span> <span class=p>=</span> <span class=nx>s2Ptr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//  下面代码无法通过编译。因为 s2Val 是一个值，而 S2 的 f 方法中没有使用值接收器
</span></span></span><span class=line><span class=cl><span class=c1>//   i = s2Val
</span></span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://golang.org/doc/effective_go.html target=_blank rel=noopener>Effective Go</a> 中有一段关于 <a class=link href=https://golang.org/doc/effective_go.html#pointers_vs_values target=_blank rel=noopener>pointers vs. values</a> 的精彩讲解。</p><p>补充:</p><ul><li>一个类型可以有值接收器方法集和指针接收器方法集<ul><li>值接收器方法集是指针接收器方法集的子集,反之不是</li></ul></li><li>规则<ul><li>值对象只可以使用值接收器方法集</li><li>指针对象可以使用 值接收器方法集 + 指针接收器方法集</li></ul></li><li>接口的匹配(或者叫实现)<ul><li>类型实现了接口的所有方法,叫匹配</li><li>具体的讲,要么是类型的值方法集匹配接口,要么是指针方法集匹配接口</li></ul></li></ul><p>具体的匹配分两种:</p><ul><li>值方法集和接口匹配<ul><li>给接口变量赋值的不管是值还是指针对象,都ok,因为都包含值方法集</li></ul></li><li>指针方法集和接口匹配<ul><li>只能将指针对象赋值给接口变量,因为只有指针方法集和接口匹配</li><li>如果将值对象赋值给接口变量,会在编译期报错(会触发接口合理性检查机制)</li></ul></li></ul><p>为啥 i = s2Val 会报错,因为值方法集和接口不匹配.</p><h3 id=零值-mutex-是有效的>零值 Mutex 是有效的</h3><p>零值 <code>sync.Mutex</code> 和 <code>sync.RWMutex</code> 是有效的。所以指向 mutex 的指针基本是不必要的。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>mu</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>如果你使用结构体指针，mutex 应该作为结构体的非指针字段。即使该结构体不被导出，也不要直接把 mutex 嵌入到结构体中。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SMap</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewSMap</span><span class=p>()</span> <span class=o>*</span><span class=nx>SMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>&amp;</span><span class=nx>SMap</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>SMap</span><span class=p>)</span> <span class=nf>Get</span><span class=p>(</span><span class=nx>k</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>m</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>m</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>m</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SMap</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewSMap</span><span class=p>()</span> <span class=o>*</span><span class=nx>SMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>&amp;</span><span class=nx>SMap</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>SMap</span><span class=p>)</span> <span class=nf>Get</span><span class=p>(</span><span class=nx>k</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>m</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>m</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>m</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><p><code>Mutex</code> 字段， <code>Lock</code> 和 <code>Unlock</code> 方法是 <code>SMap</code> 导出的 API 中不刻意说明的一部分。</p></td><td><p>mutex 及其方法是 <code>SMap</code> 的实现细节，对其调用者不可见。</p></td></tr></tbody></table><h3 id=在边界处拷贝-slices-和-maps>在边界处拷贝 Slices 和 Maps</h3><p>slices 和 maps 包含了指向底层数据的指针，因此在需要复制它们时要特别注意。</p><h4 id=接收-slices-和-maps>接收 Slices 和 Maps</h4><p>请记住，当 map 或 slice 作为函数参数传入时，如果您存储了对它们的引用，则用户可以对其进行修改。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Driver</span><span class=p>)</span> <span class=nf>SetTrips</span><span class=p>(</span><span class=nx>trips</span> <span class=p>[]</span><span class=nx>Trip</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>d</span><span class=p>.</span><span class=nx>trips</span> <span class=p>=</span> <span class=nx>trips</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>trips</span> <span class=o>:=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>d1</span><span class=p>.</span><span class=nf>SetTrips</span><span class=p>(</span><span class=nx>trips</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 你是要修改 d1.trips 吗？
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>trips</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>=</span> <span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Driver</span><span class=p>)</span> <span class=nf>SetTrips</span><span class=p>(</span><span class=nx>trips</span> <span class=p>[]</span><span class=nx>Trip</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>d</span><span class=p>.</span><span class=nx>trips</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>Trip</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>trips</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nb>copy</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>trips</span><span class=p>,</span> <span class=nx>trips</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>trips</span> <span class=o>:=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>d1</span><span class=p>.</span><span class=nf>SetTrips</span><span class=p>(</span><span class=nx>trips</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 这里我们修改 trips[0]，但不会影响到 d1.trips
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>trips</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>=</span> <span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h4 id=返回-slices-或-maps>返回 slices 或 maps</h4><p>同样，请注意用户对暴露内部状态的 map 或 slice 的修改。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Stats</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>counters</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Snapshot 返回当前状态。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Stats</span><span class=p>)</span> <span class=nf>Snapshot</span><span class=p>()</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>counters</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// snapshot 不再受互斥锁保护
</span></span></span><span class=line><span class=cl><span class=c1>// 因此对 snapshot 的任何访问都将受到数据竞争的影响
</span></span></span><span class=line><span class=cl><span class=c1>// 影响 stats.counters
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>snapshot</span> <span class=o>:=</span> <span class=nx>stats</span><span class=p>.</span><span class=nf>Snapshot</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Stats</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>counters</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Stats</span><span class=p>)</span> <span class=nf>Snapshot</span><span class=p>()</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>counters</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span><span class=p>.</span><span class=nx>counters</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>result</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span> <span class=p>=</span> <span class=nx>v</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>result</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// snapshot 现在是一个拷贝
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>snapshot</span> <span class=o>:=</span> <span class=nx>stats</span><span class=p>.</span><span class=nf>Snapshot</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=使用-defer-释放资源>使用 defer 释放资源</h3><p>使用 defer 释放资源，诸如文件和锁。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>p</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>count</span> <span class=p>&lt;</span> <span class=mi>10</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>p</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nx>count</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>p</span><span class=p>.</span><span class=nx>count</span><span class=o>++</span>
</span></span><span class=line><span class=cl><span class=nx>newCount</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>count</span>
</span></span><span class=line><span class=cl><span class=nx>p</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>newCount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 当有多个 return 分支时，很容易遗忘 unlock
</span></span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>p</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>count</span> <span class=p>&lt;</span> <span class=mi>10</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nx>count</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>p</span><span class=p>.</span><span class=nx>count</span><span class=o>++</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nx>count</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 更可读
</span></span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>Defer 的开销非常小，只有在您可以证明函数执行时间处于纳秒级的程度时，才应避免这样做。使用 defer 提升可读性是值得的，因为使用它们的成本微不足道。尤其适用于那些不仅仅是简单内存访问的较大的方法，在这些方法中其他计算的资源消耗远超过 <code>defer</code>。</p><h3 id=channel-的-size-要么是-1要么是无缓冲的>Channel 的 size 要么是 1，要么是无缓冲的</h3><p>channel 通常 size 应为 1 或是无缓冲的。默认情况下，channel 是无缓冲的，其 size 为零。任何其他尺寸都必须经过严格的审查。我们需要考虑如何确定大小，考虑是什么阻止了 channel 在高负载下和阻塞写时的写入，以及当这种情况发生时系统逻辑有哪些变化。(翻译解释：按照原文意思是需要界定通道边界，竞态条件，以及逻辑上下文梳理)</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 应该足以满足任何情况！
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>c</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 大小：1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>c</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=c1>// 或者
</span></span></span><span class=line><span class=cl><span class=c1>// 无缓冲 channel，大小为 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>c</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=枚举从-1-开始>枚举从 1 开始</h3><p>在 Go 中引入枚举的标准方法是声明一个自定义类型和一个使用了 iota 的 const 组。由于变量的默认值为 0，因此通常应以非零值开头枚举。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Operation</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Add</span> <span class=nx>Operation</span> <span class=p>=</span> <span class=kc>iota</span>
</span></span><span class=line><span class=cl>  <span class=nx>Subtract</span>
</span></span><span class=line><span class=cl>  <span class=nx>Multiply</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Add=0, Subtract=1, Multiply=2
</span></span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Operation</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Add</span> <span class=nx>Operation</span> <span class=p>=</span> <span class=kc>iota</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>Subtract</span>
</span></span><span class=line><span class=cl>  <span class=nx>Multiply</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Add=1, Subtract=2, Multiply=3
</span></span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>在某些情况下，使用零值是有意义的（枚举从零开始），例如，当零值是理想的默认行为时。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>LogOutput</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>LogToStdout</span> <span class=nx>LogOutput</span> <span class=p>=</span> <span class=kc>iota</span>
</span></span><span class=line><span class=cl>  <span class=nx>LogToFile</span>
</span></span><span class=line><span class=cl>  <span class=nx>LogToRemote</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// LogToStdout=0, LogToFile=1, LogToRemote=2
</span></span></span></code></pre></td></tr></table></div></div><h3 id=使用-time-处理时间>使用 time 处理时间</h3><p>时间处理很复杂。关于时间的错误假设通常包括以下几点。</p><ol><li>一天有 24 小时</li><li>一小时有 60 分钟</li><li>一周有七天</li><li>一年 365 天</li><li><a class=link href=https://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time target=_blank rel=noopener>还有更多</a></li></ol><p>例如，<em>1</em> 表示在一个时间点上加上 24 小时并不总是产生一个新的日历日。</p><p>因此，在处理时间时始终使用 <a class=link href=https://golang.org/pkg/time/ target=_blank rel=noopener><code>"time"</code></a> 包，因为它有助于以更安全、更准确的方式处理这些不正确的假设。</p><h4 id=使用-timetime-表达瞬时时间>使用 <code>time.Time</code> 表达瞬时时间</h4><p>在处理时间的瞬间时使用 <a class=link href=https://golang.org/pkg/time/#Time target=_blank rel=noopener><code>time.Time</code></a>，在比较、添加或减去时间时使用 <code>time.Time</code> 中的方法。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>isActive</span><span class=p>(</span><span class=nx>now</span><span class=p>,</span> <span class=nx>start</span><span class=p>,</span> <span class=nx>stop</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>start</span> <span class=o>&lt;=</span> <span class=nx>now</span> <span class=o>&amp;&amp;</span> <span class=nx>now</span> <span class=p>&lt;</span> <span class=nx>stop</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>isActive</span><span class=p>(</span><span class=nx>now</span><span class=p>,</span> <span class=nx>start</span><span class=p>,</span> <span class=nx>stop</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=nx>start</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>now</span><span class=p>)</span> <span class=o>||</span> <span class=nx>start</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>now</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=nx>now</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h4 id=使用-timeduration-表达时间段>使用 <code>time.Duration</code> 表达时间段</h4><p>在处理时间段时使用 <a class=link href=https://golang.org/pkg/time/#Duration target=_blank rel=noopener><code>time.Duration</code></a> .</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>poll</span><span class=p>(</span><span class=nx>delay</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>delay</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>poll</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=c1>// 是几秒钟还是几毫秒?
</span></span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>poll</span><span class=p>(</span><span class=nx>delay</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>delay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>poll</span><span class=p>(</span><span class=mi>10</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>回到第一个例子，在一个时间瞬间加上 24 小时，我们用于添加时间的方法取决于意图。如果我们想要下一个日历日(当前天的下一天)的同一个时间点，我们应该使用 <a class=link href=https://golang.org/pkg/time/#Time.AddDate target=_blank rel=noopener><code>Time.AddDate</code></a>。但是，如果我们想保证某一时刻比前一时刻晚 24 小时，我们应该使用 <a class=link href=https://golang.org/pkg/time/#Time.Add target=_blank rel=noopener><code>Time.Add</code></a>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>newDay</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>AddDate</span><span class=p>(</span><span class=mi>0</span> <span class=cm>/* years */</span><span class=p>,</span> <span class=mi>0</span> <span class=cm>/* months */</span><span class=p>,</span> <span class=mi>1</span> <span class=cm>/* days */</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>maybeNewDay</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>24</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Hour</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=对外部系统使用-timetime-和-timeduration>对外部系统使用 <code>time.Time</code> 和 <code>time.Duration</code></h4><p>尽可能在与外部系统的交互中使用 <code>time.Duration</code> 和 <code>time.Time</code> 例如 :</p><ul><li><p>Command-line 标志: <a class=link href=https://golang.org/pkg/flag/ target=_blank rel=noopener><code>flag</code></a> 通过 <a class=link href=https://golang.org/pkg/time/#ParseDuration target=_blank rel=noopener><code>time.ParseDuration</code></a> 支持 <code>time.Duration</code></p></li><li><p>JSON: <a class=link href=https://golang.org/pkg/encoding/json/ target=_blank rel=noopener><code>encoding/json</code></a> 通过其 <a class=link href=https://golang.org/pkg/time/#Time.UnmarshalJSON target=_blank rel=noopener><code>UnmarshalJSON</code> method</a> 方法支持将 <code>time.Time</code> 编码为 <a class=link href=https://tools.ietf.org/html/rfc3339 target=_blank rel=noopener>RFC 3339</a> 字符串</p></li><li><p>SQL: <a class=link href=https://golang.org/pkg/database/sql/ target=_blank rel=noopener><code>database/sql</code></a> 支持将 <code>DATETIME</code> 或 <code>TIMESTAMP</code> 列转换为 <code>time.Time</code>，如果底层驱动程序支持则返回</p></li><li><p>YAML: <a class=link href=https://godoc.org/gopkg.in/yaml.v2 target=_blank rel=noopener><code>gopkg.in/yaml.v2</code></a> 支持将 <code>time.Time</code> 作为 <a class=link href=https://tools.ietf.org/html/rfc3339 target=_blank rel=noopener>RFC 3339</a> 字符串，并通过 <a class=link href=https://golang.org/pkg/time/#ParseDuration target=_blank rel=noopener><code>time.ParseDuration</code></a> 支持 <code>time.Duration</code>。</p></li></ul><p>当不能在这些交互中使用 <code>time.Duration</code> 时，请使用 <code>int</code> 或 <code>float64</code>，并在字段名称中包含单位。</p><p>例如，由于 <code>encoding/json</code> 不支持 <code>time.Duration</code>，因此该单位包含在字段的名称中。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// {&#34;interval&#34;: 2}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Interval</span> <span class=kt>int</span> <span class=s>`json:&#34;interval&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// {&#34;intervalMillis&#34;: 2000}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>IntervalMillis</span> <span class=kt>int</span> <span class=s>`json:&#34;intervalMillis&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>当在这些交互中不能使用 <code>time.Time</code> 时，除非达成一致，否则使用 <code>string</code> 和 <a class=link href=https://tools.ietf.org/html/rfc3339 target=_blank rel=noopener>RFC 3339</a> 中定义的格式时间戳。默认情况下，<a class=link href=https://golang.org/pkg/time/#Time.UnmarshalText target=_blank rel=noopener><code>Time.UnmarshalText</code></a> 使用此格式，并可通过 <a class=link href=https://golang.org/pkg/time/#RFC3339 target=_blank rel=noopener><code>time.RFC3339</code></a> 在 <code>Time.Format</code> 和 <code>time.Parse</code> 中使用。</p><p>尽管这在实践中并不成问题，但请记住，<code>"time"</code> 包不支持解析闰秒时间戳（<a class=link href=https://github.com/golang/go/issues/8728 target=_blank rel=noopener>8728</a>），也不在计算中考虑闰秒（<a class=link href=https://github.com/golang/go/issues/15190 target=_blank rel=noopener>15190</a>）。如果您比较两个时间瞬间，则差异将不包括这两个瞬间之间可能发生的闰秒。</p><h3 id=错误类型>错误类型</h3><p>Go 中有多种声明错误（Error) 的选项：</p><ul><li><a class=link href=https://golang.org/pkg/errors/#New target=_blank rel=noopener><code>errors.New</code></a> 对于简单静态字符串的错误</li><li><a class=link href=https://golang.org/pkg/fmt/#Errorf target=_blank rel=noopener><code>fmt.Errorf</code></a> 用于格式化的错误字符串</li><li>实现 <code>Error()</code> 方法的自定义类型</li><li>用 <a class=link href=https://godoc.org/github.com/pkg/errors#Wrap target=_blank rel=noopener><code>"pkg/errors".Wrap</code></a> 的 Wrapped errors</li></ul><p>返回错误时，请考虑以下因素以确定最佳选择：</p><ul><li><p>这是一个不需要额外信息的简单错误吗？如果是这样，<a class=link href=https://golang.org/pkg/errors/#New target=_blank rel=noopener><code>errors.New</code></a> 足够了。</p></li><li><p>客户需要检测并处理此错误吗？如果是这样，则应使用自定义类型并实现该 <code>Error()</code> 方法。</p></li><li><p>您是否正在传播下游函数返回的错误？如果是这样，请查看本文后面有关错误包装 <a class=link href=#%e9%94%99%e8%af%af%e5%8c%85%e8%a3%85 title=Error-Wrapping>section on error wrapping</a> 部分的内容。</p></li><li><p>否则 <a class=link href=https://golang.org/pkg/fmt/#Errorf target=_blank rel=noopener><code>fmt.Errorf</code></a> 就可以了。</p></li></ul><p>如果客户端需要检测错误，并且您已使用创建了一个简单的错误 <a class=link href=https://golang.org/pkg/errors/#New target=_blank rel=noopener><code>errors.New</code></a>，请使用一个错误变量。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// package foo
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Open</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;could not open&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// package bar
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>use</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>foo</span><span class=p>.</span><span class=nf>Open</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()</span> <span class=o>==</span> <span class=s>&#34;could not open&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// handle
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unknown error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// package foo
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ErrCouldNotOpen</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;could not open&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Open</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>ErrCouldNotOpen</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// package bar
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>foo</span><span class=p>.</span><span class=nf>Open</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>ErrCouldNotOpen</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// handle
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unknown error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>如果您有可能需要客户端检测的错误，并且想向其中添加更多信息（例如，它不是静态字符串），则应使用自定义类型。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>open</span><span class=p>(</span><span class=nx>file</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;file %q not found&#34;</span><span class=p>,</span> <span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>use</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;testfile.txt&#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=s>&#34;not found&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// handle
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unknown error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>errNotFound</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>file</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>e</span> <span class=nx>errNotFound</span><span class=p>)</span> <span class=nf>Error</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;file %q not found&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>open</span><span class=p>(</span><span class=nx>file</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>errNotFound</span><span class=p>{</span><span class=nx>file</span><span class=p>:</span> <span class=nx>file</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>use</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;testfile.txt&#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>errNotFound</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// handle
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unknown error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>直接导出自定义错误类型时要小心，因为它们已成为程序包公共 API 的一部分。最好公开匹配器功能以检查错误。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// package foo
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>errNotFound</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>file</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>e</span> <span class=nx>errNotFound</span><span class=p>)</span> <span class=nf>Error</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;file %q not found&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>IsNotFoundError</span><span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>errNotFound</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>ok</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Open</span><span class=p>(</span><span class=nx>file</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>errNotFound</span><span class=p>{</span><span class=nx>file</span><span class=p>:</span> <span class=nx>file</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// package bar
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>foo</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>foo</span><span class=p>.</span><span class=nf>IsNotFoundError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// handle
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unknown error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=错误包装-error-wrapping>错误包装 (Error Wrapping)</h3><p>一个（函数/方法）调用失败时，有三种主要的错误传播方式：</p><ul><li>如果没有要添加的其他上下文，并且您想要维护原始错误类型，则返回原始错误。</li><li>添加上下文，使用 <a class=link href=https://godoc.org/github.com/pkg/errors#Wrap target=_blank rel=noopener><code>"pkg/errors".Wrap</code></a> 以便错误消息提供更多上下文 ,<a class=link href=https://godoc.org/github.com/pkg/errors#Cause target=_blank rel=noopener><code>"pkg/errors".Cause</code></a> 可用于提取原始错误。</li><li>如果调用者不需要检测或处理的特定错误情况，使用 <a class=link href=https://golang.org/pkg/fmt/#Errorf target=_blank rel=noopener><code>fmt.Errorf</code></a>。</li></ul><p>建议在可能的地方添加上下文，以使您获得诸如“调用服务 foo：连接被拒绝”之类的更有用的错误，而不是诸如“连接被拒绝”之类的模糊错误。</p><p>在将上下文添加到返回的错误时，请避免使用“failed to”之类的短语以保持上下文简洁，这些短语会陈述明显的内容，并随着错误在堆栈中的渗透而逐渐堆积：</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>store</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;failed to create new store: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>store</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;new store: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><tr><td><pre tabindex=0><code>failed to x: failed to y: failed to create new store: the error
</code></pre></td><td><pre tabindex=0><code>x: y: new store: the error
</code></pre></td></tr></tbody></table><p>但是，一旦将错误发送到另一个系统，就应该明确消息是错误消息（例如使用<code>err</code>标记，或在日志中以”Failed”为前缀）。</p><p>另请参见 <a class=link href=https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully target=_blank rel=noopener>Don&rsquo;t just check errors, handle them gracefully</a>. 不要只是检查错误，要优雅地处理错误</p><h3 id=处理类型断言失败>处理类型断言失败</h3><p><a class=link href=https://golang.org/ref/spec#Type_assertions target=_blank rel=noopener>type assertion</a> 的单个返回值形式针对不正确的类型将产生 panic。因此，请始终使用“comma ok”的惯用法。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>t</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.(</span><span class=kt>string</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>t</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.(</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 优雅地处理错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=不要-panic>不要 panic</h3><p>在生产环境中运行的代码必须避免出现 panic。panic 是 <a class=link href=https://en.wikipedia.org/wiki/Cascading_failure target=_blank rel=noopener>cascading failures</a> 级联失败的主要根源 。如果发生错误，该函数必须返回错误，并允许调用方决定如何处理它。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>run</span><span class=p>(</span><span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;an argument is required&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>run</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>run</span><span class=p>(</span><span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;an argument is required&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>run</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>:]);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintln</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>panic/recover 不是错误处理策略。仅当发生不可恢复的事情（例如：nil 引用）时，程序才必须 panic。程序初始化是一个例外：程序启动时应使程序中止的不良情况可能会引起 panic。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_statusTemplate</span> <span class=p>=</span> <span class=nx>template</span><span class=p>.</span><span class=nf>Must</span><span class=p>(</span><span class=nx>template</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span><span class=nf>Parse</span><span class=p>(</span><span class=s>&#34;_statusHTML&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>即使在测试代码中，也优先使用<code>t.Fatal</code>或者<code>t.FailNow</code>而不是 panic 来确保失败被标记。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// func TestFoo(t *testing.T)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>TempFile</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;failed to set up test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// func TestFoo(t *testing.T)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>TempFile</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>t</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;failed to set up test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=使用-gouberorgatomic>使用 go.uber.org/atomic</h3><p>使用 <a class=link href=https://golang.org/pkg/sync/atomic/ target=_blank rel=noopener>sync/atomic</a> 包的原子操作对原始类型 (<code>int32</code>, <code>int64</code>等）进行操作，因为很容易忘记使用原子操作来读取或修改变量。</p><p><a class=link href=https://godoc.org/go.uber.org/atomic target=_blank rel=noopener>go.uber.org/atomic</a> 通过隐藏基础类型为这些操作增加了类型安全性。此外，它包括一个方便的<code>atomic.Bool</code>类型。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>foo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>running</span> <span class=kt>int32</span>  <span class=c1>// atomic
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span><span class=o>*</span> <span class=nx>foo</span><span class=p>)</span> <span class=nf>start</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>SwapInt32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>f</span><span class=p>.</span><span class=nx>running</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>// already running…
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// start the Foo
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>foo</span><span class=p>)</span> <span class=nf>isRunning</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=nx>running</span> <span class=o>==</span> <span class=mi>1</span>  <span class=c1>// race!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>foo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>running</span> <span class=nx>atomic</span><span class=p>.</span><span class=nx>Bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>foo</span><span class=p>)</span> <span class=nf>start</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>running</span><span class=p>.</span><span class=nf>Swap</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>// already running…
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// start the Foo
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>foo</span><span class=p>)</span> <span class=nf>isRunning</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=nx>running</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=避免可变全局变量>避免可变全局变量</h3><p>使用选择依赖注入方式避免改变全局变量。
既适用于函数指针又适用于其他值类型</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// sign.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>_timeNow</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Now</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>sign</span><span class=p>(</span><span class=nx>msg</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>now</span> <span class=o>:=</span> <span class=nf>_timeNow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>signWithTime</span><span class=p>(</span><span class=nx>msg</span><span class=p>,</span> <span class=nx>now</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// sign.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>signer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>now</span> <span class=kd>func</span><span class=p>()</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newSigner</span><span class=p>()</span> <span class=o>*</span><span class=nx>signer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>&amp;</span><span class=nx>signer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>now</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>signer</span><span class=p>)</span> <span class=nf>Sign</span><span class=p>(</span><span class=nx>msg</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>now</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>signWithTime</span><span class=p>(</span><span class=nx>msg</span><span class=p>,</span> <span class=nx>now</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// sign_test.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>TestSign</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>oldTimeNow</span> <span class=o>:=</span> <span class=nx>_timeNow</span>
</span></span><span class=line><span class=cl>  <span class=nx>_timeNow</span> <span class=p>=</span> <span class=kd>func</span><span class=p>()</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>someFixedTime</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nx>_timeNow</span> <span class=p>=</span> <span class=nx>oldTimeNow</span> <span class=p>}()</span>
</span></span><span class=line><span class=cl>  <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>want</span><span class=p>,</span> <span class=nf>sign</span><span class=p>(</span><span class=nx>give</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// sign_test.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>TestSigner</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span> <span class=o>:=</span> <span class=nf>newSigner</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>now</span> <span class=p>=</span> <span class=kd>func</span><span class=p>()</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>someFixedTime</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>want</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Sign</span><span class=p>(</span><span class=nx>give</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=避免在公共结构中嵌入类型>避免在公共结构中嵌入类型</h3><p>这些嵌入的类型泄漏实现细节、禁止类型演化和模糊的文档。</p><p>假设您使用共享的 <code>AbstractList</code> 实现了多种列表类型，请避免在具体的列表实现中嵌入 <code>AbstractList</code>。
相反，只需手动将方法写入具体的列表，该列表将委托给抽象列表。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>AbstractList</span> <span class=kd>struct</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=c1>// 添加将实体添加到列表中。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>AbstractList</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>e</span> <span class=nx>Entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 移除从列表中移除实体。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>AbstractList</span><span class=p>)</span> <span class=nf>Remove</span><span class=p>(</span><span class=nx>e</span> <span class=nx>Entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ConcreteList 是一个实体列表。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ConcreteList</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=nx>AbstractList</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ConcreteList 是一个实体列表。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ConcreteList</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>list</span> <span class=o>*</span><span class=nx>AbstractList</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 添加将实体添加到列表中。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>ConcreteList</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>e</span> <span class=nx>Entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>l</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 移除从列表中移除实体。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>ConcreteList</span><span class=p>)</span> <span class=nf>Remove</span><span class=p>(</span><span class=nx>e</span> <span class=nx>Entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>l</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>Go 允许 <a class=link href=https://golang.org/doc/effective_go.html#embedding target=_blank rel=noopener>类型嵌入</a> 作为继承和组合之间的折衷。
外部类型获取嵌入类型的方法的隐式副本。
默认情况下，这些方法委托给嵌入实例的同一方法。</p><p>结构还获得与类型同名的字段。
所以，如果嵌入的类型是 public，那么字段是 public。为了保持向后兼容性，外部类型的每个未来版本都必须保留嵌入类型。</p><p>很少需要嵌入类型。
这是一种方便，可以帮助您避免编写冗长的委托方法。</p><p>即使嵌入兼容的抽象列表 <em>interface</em>，而不是结构体，这将为开发人员提供更大的灵活性来改变未来，但仍然泄露了具体列表使用抽象实现的细节。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// AbstractList 是各种实体列表的通用实现。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>AbstractList</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>Add</span><span class=p>(</span><span class=nx>Entity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nf>Remove</span><span class=p>(</span><span class=nx>Entity</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// ConcreteList 是一个实体列表。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ConcreteList</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>AbstractList</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ConcreteList 是一个实体列表。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ConcreteList</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>list</span> <span class=nx>AbstractList</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 添加将实体添加到列表中。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>ConcreteList</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>e</span> <span class=nx>Entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>l</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 移除从列表中移除实体。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>ConcreteList</span><span class=p>)</span> <span class=nf>Remove</span><span class=p>(</span><span class=nx>e</span> <span class=nx>Entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>l</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>无论是使用嵌入式结构还是使用嵌入式接口，嵌入式类型都会限制类型的演化.</p><ul><li>向嵌入式接口添加方法是一个破坏性的改变。</li><li>删除嵌入类型是一个破坏性的改变。</li><li>即使使用满足相同接口的替代方法替换嵌入类型，也是一个破坏性的改变。</li></ul><p>尽管编写这些委托方法是乏味的，但是额外的工作隐藏了实现细节，留下了更多的更改机会，还消除了在文档中发现完整列表接口的间接性操作。</p><h3 id=避免使用内置名称>避免使用内置名称</h3><p>Go语言规范<a class=link href=https://golang.org/ref/spec target=_blank rel=noopener>language specification</a> 概述了几个内置的，
不应在Go项目中使用的名称标识<a class=link href=https://golang.org/ref/spec#Predeclared_identifiers target=_blank rel=noopener>predeclared identifiers</a>。</p><p>根据上下文的不同，将这些标识符作为名称重复使用，
将在当前作用域（或任何嵌套作用域）中隐藏原始标识符，或者混淆代码。
在最好的情况下，编译器会报错；在最坏的情况下，这样的代码可能会引入潜在的、难以恢复的错误。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=kt>error</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=c1>// `error` 作用域隐式覆盖
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// or
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>handleErrorMessage</span><span class=p>(</span><span class=kt>error</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// `error` 作用域隐式覆盖
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>errorMessage</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=c1>// `error` 指向内置的非覆盖
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// or
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>handleErrorMessage</span><span class=p>(</span><span class=nx>msg</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// `error` 指向内置的非覆盖
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Foo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 虽然这些字段在技术上不构成阴影，但`error`或`string`字符串的重映射现在是不明确的。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>error</span>  <span class=kt>error</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=nx>Foo</span><span class=p>)</span> <span class=nf>Error</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// `error` 和 `f.error` 在视觉上是相似的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=nx>Foo</span><span class=p>)</span> <span class=nf>String</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// `string` and `f.string` 在视觉上是相似的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Foo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// `error` and `string` 现在是明确的。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>    <span class=nx>str</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=nx>Foo</span><span class=p>)</span> <span class=nf>Error</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=nx>Foo</span><span class=p>)</span> <span class=nf>String</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=nx>str</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>注意，编译器在使用预先分隔的标识符时不会生成错误，
但是诸如<code>go vet</code>之类的工具会正确地指出这些和其他情况下的隐式问题。</p><h3 id=避免使用-init>避免使用 <code>init()</code></h3><p>尽可能避免使用<code>init()</code>。当<code>init()</code>是不可避免或可取的，代码应先尝试：</p><ol><li>无论程序环境或调用如何，都要完全确定。</li><li>避免依赖于其他<code>init()</code>函数的顺序或副作用。虽然<code>init()</code>顺序是明确的，但代码可以更改，
因此<code>init()</code>函数之间的关系可能会使代码变得脆弱和容易出错。</li><li>避免访问或操作全局或环境状态，如机器信息、环境变量、工作目录、程序参数/输入等。</li><li>避免<code>I/O</code>，包括文件系统、网络和系统调用。</li></ol><p>不能满足这些要求的代码可能属于要作为<code>main()</code>调用的一部分（或程序生命周期中的其他地方），
或者作为<code>main()</code>本身的一部分写入。特别是，打算由其他程序使用的库应该特别注意完全确定性，
而不是执行“init magic”</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Foo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_defaultFoo</span> <span class=nx>Foo</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>_defaultFoo</span> <span class=p>=</span> <span class=nx>Foo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_defaultFoo</span> <span class=p>=</span> <span class=nx>Foo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// or, 为了更好的可测试性:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>_defaultFoo</span> <span class=p>=</span> <span class=nf>defaultFoo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>defaultFoo</span><span class=p>()</span> <span class=nx>Foo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>Foo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_config</span> <span class=nx>Config</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Bad: 基于当前目录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>cwd</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getwd</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Bad: I/O
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>raw</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>path</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>cwd</span><span class=p>,</span> <span class=s>&#34;config&#34;</span><span class=p>,</span> <span class=s>&#34;config.yaml&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>yaml</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>raw</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>loadConfig</span><span class=p>()</span> <span class=nx>Config</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cwd</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getwd</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// handle err
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>raw</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>path</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>cwd</span><span class=p>,</span> <span class=s>&#34;config&#34;</span><span class=p>,</span> <span class=s>&#34;config.yaml&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// handle err
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>config</span> <span class=nx>Config</span>
</span></span><span class=line><span class=cl>    <span class=nx>yaml</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>raw</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>config</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>考虑到上述情况，在某些情况下，<code>init()</code>可能更可取或是必要的，可能包括：</p><ul><li><p>不能表示为单个赋值的复杂表达式。</p></li><li><p>可插入的钩子，如<code>database/sql</code>、编码类型注册表等。</p></li><li><p>对<a class=link href=https://cloud.google.com/functions/docs/bestpractices/tips#use_global_variables_to_reuse_objects_in_future_invocations target=_blank rel=noopener>Google Cloud Functions</a>和其他形式的确定性预计算的优化。</p></li></ul><h3 id=追加时优先指定切片容量>追加时优先指定切片容量</h3><p>追加时优先指定切片容量</p><p>在尽可能的情况下，在初始化要追加的切片时为<code>make()</code>提供一个容量值。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>n</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>n</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>n</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>k</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>k</span> <span class=p>&lt;</span> <span class=nx>size</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>n</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>n</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>n</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>k</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>k</span> <span class=p>&lt;</span> <span class=nx>size</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><pre tabindex=0><code>BenchmarkBad-4    100000000    2.48s
</code></pre></td><td><pre tabindex=0><code>BenchmarkGood-4   100000000    0.21s
</code></pre></td></tr></tbody></table><h3 id=主函数退出方式exit>主函数退出方式(Exit)</h3><p>Go程序使用<a class=link href=https://golang.org/pkg/os/#Exit target=_blank rel=noopener><code>os.Exit</code></a> 或者 <a class=link href=https://golang.org/pkg/log/#Fatal target=_blank rel=noopener><code>log.Fatal*</code></a> 立即退出 (使用<code>panic</code>不是退出程序的好方法，请 <a class=link href=#%e4%b8%8d%e8%a6%81-panic>don&rsquo;t panic</a>.)</p><p>**仅在<code>main()</code>**中调用其中一个 <code>os.Exit</code> 或者 <code>log.Fatal*</code>。所有其他函数应将错误返回到信号失败中。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>body</span> <span class=o>:=</span> <span class=nf>readFile</span><span class=p>(</span><span class=nx>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>readFile</span><span class=p>(</span><span class=nx>path</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nb>string</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>body</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>readFile</span><span class=p>(</span><span class=nx>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>readFile</span><span class=p>(</span><span class=nx>path</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nb>string</span><span class=p>(</span><span class=nx>b</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>原则上：退出的具有多种功能的程序存在一些问题：</p><ul><li>不明显的控制流：任何函数都可以退出程序，因此很难对控制流进行推理。</li><li>难以测试：退出程序的函数也将退出调用它的测试。这使得函数很难测试，并引入了跳过 <code>go test</code> 尚未运行的其他测试的风险。</li><li>跳过清理：当函数退出程序时，会跳过已经进入<code>defer</code>队列里的函数调用。这增加了跳过重要清理任务的风险。</li></ul><h4 id=一次性退出>一次性退出</h4><p>如果可能的话，你的<code>main（）</code>函数中<strong>最多一次</strong> 调用 <code>os.Exit</code>或者<code>log.Fatal</code>。如果有多个错误场景停止程序执行，请将该逻辑放在单独的函数下并从中返回错误。
这会缩短 <code>main()</code>函数，并将所有关键业务逻辑放入一个单独的、可测试的函数中。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>args</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;missing file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果我们调用log.Fatal 在这条线之后
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// f.Close 将会被执行.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>run</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>run</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>args</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;missing file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h2 id=性能>性能</h2><p>性能方面的特定准则只适用于高频场景。</p><h3 id=优先使用-strconv-而不是-fmt>优先使用 strconv 而不是 fmt</h3><p>将原语转换为字符串或从字符串转换时，<code>strconv</code>速度比<code>fmt</code>快。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprint</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Int</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Int</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><pre tabindex=0><code>BenchmarkFmtSprint-4    143 ns/op    2 allocs/op
</code></pre></td><td><pre tabindex=0><code>BenchmarkStrconv-4    64.2 ns/op    1 allocs/op
</code></pre></td></tr></tbody></table><h3 id=避免字符串到字节的转换>避免字符串到字节的转换</h3><p>不要反复从固定字符串创建字节 slice。相反，请执行一次转换并捕获结果。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;Hello world&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>data</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;Hello world&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></tr><tr><td><pre tabindex=0><code>BenchmarkBad-4   50000000   22.2 ns/op
</code></pre></td><td><pre tabindex=0><code>BenchmarkGood-4  500000000   3.25 ns/op
</code></pre></td></tr></tbody></table><h3 id=指定容器容量>指定容器容量</h3><p>尽可能指定容器容量，以便为容器预先分配内存。这将在添加元素时最小化后续分配（通过复制和调整容器大小）。</p><h4 id=指定map容量提示>指定Map容量提示</h4><p>在尽可能的情况下，在使用 <code>make()</code> 初始化的时候提供容量信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>T1</span><span class=p>]</span><span class=nx>T2</span><span class=p>,</span> <span class=nx>hint</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>向<code>make()</code>提供容量提示会在初始化时尝试调整map的大小，这将减少在将元素添加到map时为map重新分配内存。</p><p>注意，与slices不同。map capacity提示并不保证完全的抢占式分配，而是用于估计所需的hashmap bucket的数量。
因此，在将元素添加到map时，甚至在指定map容量时，仍可能发生分配。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>os</span><span class=p>.</span><span class=nx>FileInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>files</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadDir</span><span class=p>(</span><span class=s>&#34;./files&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>f</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>files</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>m</span><span class=p>[</span><span class=nx>f</span><span class=p>.</span><span class=nf>Name</span><span class=p>()]</span> <span class=p>=</span> <span class=nx>f</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>files</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadDir</span><span class=p>(</span><span class=s>&#34;./files&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>m</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>os</span><span class=p>.</span><span class=nx>FileInfo</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>files</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>f</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>files</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>m</span><span class=p>[</span><span class=nx>f</span><span class=p>.</span><span class=nf>Name</span><span class=p>()]</span> <span class=p>=</span> <span class=nx>f</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><p><code>m</code> 是在没有大小提示的情况下创建的； 在运行时可能会有更多分配。</p></td><td><p><code>m</code> 是有大小提示创建的；在运行时可能会有更少的分配。</p></td></tr></tbody></table><h4 id=指定切片容量>指定切片容量</h4><p>在尽可能的情况下，在使用<code>make()</code>初始化切片时提供容量信息，特别是在追加切片时。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nb>make</span><span class=p>([]</span><span class=nx>T</span><span class=p>,</span> <span class=nx>length</span><span class=p>,</span> <span class=nx>capacity</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>与maps不同，slice capacity不是一个提示：编译器将为提供给<code>make()</code>的slice的容量分配足够的内存，
这意味着后续的append()`操作将导致零分配（直到slice的长度与容量匹配，在此之后，任何append都可能调整大小以容纳其他元素）。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>n</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>n</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>n</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>k</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>k</span> <span class=p>&lt;</span> <span class=nx>size</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>n</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>n</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>n</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>k</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>k</span> <span class=p>&lt;</span> <span class=nx>size</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><pre tabindex=0><code>BenchmarkBad-4    100000000    2.48s
</code></pre></td><td><pre tabindex=0><code>BenchmarkGood-4   100000000    0.21s
</code></pre></td></tr></tbody></table><h2 id=规范>规范</h2><h3 id=一致性>一致性</h3><p>本文中概述的一些标准都是客观性的评估，是根据场景、上下文、或者主观性的判断；</p><p>但是最重要的是，<strong>保持一致</strong>.</p><p>一致性的代码更容易维护、是更合理的、需要更少的学习成本、并且随着新的约定出现或者出现错误后更容易迁移、更新、修复 bug</p><p>相反，在一个代码库中包含多个完全不同或冲突的代码风格会导致维护成本开销、不确定性和认知偏差。所有这些都会直接导致速度降低、代码审查痛苦、而且增加 bug 数量。</p><p>将这些标准应用于代码库时，建议在 package（或更大）级别进行更改，子包级别的应用程序通过将多个样式引入到同一代码中，违反了上述关注点。</p><h3 id=相似的声明放在一组>相似的声明放在一组</h3><p>Go 语言支持将相似的声明放在一个组内。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;a&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;b&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;a&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;b&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>这同样适用于常量、变量和类型声明：</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>a</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>b</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>a</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>b</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Area</span> <span class=kt>float64</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Volume</span> <span class=kt>float64</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>a</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>b</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>a</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>b</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Area</span> <span class=kt>float64</span>
</span></span><span class=line><span class=cl>  <span class=nx>Volume</span> <span class=kt>float64</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>仅将相关的声明放在一组。不要将不相关的声明放在一组。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Operation</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Add</span> <span class=nx>Operation</span> <span class=p>=</span> <span class=kc>iota</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>Subtract</span>
</span></span><span class=line><span class=cl>  <span class=nx>Multiply</span>
</span></span><span class=line><span class=cl>  <span class=nx>EnvVar</span> <span class=p>=</span> <span class=s>&#34;MY_ENV&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Operation</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Add</span> <span class=nx>Operation</span> <span class=p>=</span> <span class=kc>iota</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>Subtract</span>
</span></span><span class=line><span class=cl>  <span class=nx>Multiply</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>EnvVar</span> <span class=p>=</span> <span class=s>&#34;MY_ENV&#34;</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>分组使用的位置没有限制，例如：你可以在函数内部使用它们：</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>f</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>red</span> <span class=p>=</span> <span class=nx>color</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=mh>0xff0000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>green</span> <span class=p>=</span> <span class=nx>color</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=mh>0x00ff00</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>blue</span> <span class=p>=</span> <span class=nx>color</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=mh>0x0000ff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>f</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>red</span>   <span class=p>=</span> <span class=nx>color</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=mh>0xff0000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>green</span> <span class=p>=</span> <span class=nx>color</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=mh>0x00ff00</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>blue</span>  <span class=p>=</span> <span class=nx>color</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=mh>0x0000ff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=import-分组>import 分组</h3><p>导入应该分为两组：</p><ul><li>标准库</li><li>其他库</li></ul><p>默认情况下，这是 goimports 应用的分组。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;go.uber.org/atomic&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;golang.org/x/sync/errgroup&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s>&#34;go.uber.org/atomic&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;golang.org/x/sync/errgroup&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=包名>包名</h3><p>当命名包时，请按下面规则选择一个名称：</p><ul><li>全部小写。没有大写或下划线。</li><li>大多数使用命名导入的情况下，不需要重命名。</li><li>简短而简洁。请记住，在每个使用的地方都完整标识了该名称。</li><li>不用复数。例如<code>net/url</code>，而不是<code>net/urls</code>。</li><li>不要用“common”，“util”，“shared”或“lib”。这些是不好的，信息量不足的名称。</li></ul><p>另请参阅 <a class=link href=https://blog.golang.org/package-names target=_blank rel=noopener>Package Names</a> 和 <a class=link href=https://rakyll.org/style-packages/ target=_blank rel=noopener>Go 包样式指南</a>.</p><h3 id=函数名>函数名</h3><p>我们遵循 Go 社区关于使用 <a class=link href=https://golang.org/doc/effective_go.html#mixed-caps target=_blank rel=noopener>MixedCaps 作为函数名</a> 的约定。有一个例外，为了对相关的测试用例进行分组，函数名可能包含下划线，如：<code>TestMyFunction_WhatIsBeingTested</code>.</p><h3 id=导入别名>导入别名</h3><p>如果程序包名称与导入路径的最后一个元素不匹配，则必须使用导入别名。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>client</span> <span class=s>&#34;example.com/client-go&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>trace</span> <span class=s>&#34;example.com/trace/v2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在所有其他情况下，除非导入之间有直接冲突，否则应避免导入别名。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>nettrace</span> <span class=s>&#34;golang.net/x/trace&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;runtime/trace&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>nettrace</span> <span class=s>&#34;golang.net/x/trace&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=函数分组与顺序>函数分组与顺序</h3><ul><li>函数应按粗略的调用顺序排序。</li><li>同一文件中的函数应按接收者分组。</li></ul><p>因此，导出的函数应先出现在文件中，放在<code>struct</code>, <code>const</code>, <code>var</code>定义的后面。</p><p>在定义类型之后，但在接收者的其余方法之前，可能会出现一个 <code>newXYZ()</code>/<code>NewXYZ()</code></p><p>由于函数是按接收者分组的，因此普通工具函数应在文件末尾出现。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>something</span><span class=p>)</span> <span class=nf>Cost</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>calcCost</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>something</span> <span class=kd>struct</span><span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>calcCost</span><span class=p>(</span><span class=nx>n</span> <span class=p>[]</span><span class=kt>int</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span><span class=o>...</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>something</span><span class=p>)</span> <span class=nf>Stop</span><span class=p>()</span> <span class=p>{</span><span class=o>...</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newSomething</span><span class=p>()</span> <span class=o>*</span><span class=nx>something</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>something</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>something</span> <span class=kd>struct</span><span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newSomething</span><span class=p>()</span> <span class=o>*</span><span class=nx>something</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>something</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>something</span><span class=p>)</span> <span class=nf>Cost</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>calcCost</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>something</span><span class=p>)</span> <span class=nf>Stop</span><span class=p>()</span> <span class=p>{</span><span class=o>...</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>calcCost</span><span class=p>(</span><span class=nx>n</span> <span class=p>[]</span><span class=kt>int</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span><span class=o>...</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=减少嵌套>减少嵌套</h3><p>代码应通过尽可能先处理错误情况/特殊情况并尽早返回或继续循环来减少嵌套。减少嵌套多个级别的代码的代码量。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>data</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>v</span><span class=p>.</span><span class=nx>F1</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>v</span> <span class=p>=</span> <span class=nf>process</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.</span><span class=nf>Call</span><span class=p>();</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>v</span><span class=p>.</span><span class=nf>Send</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Invalid v: %v&#34;</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>data</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>v</span><span class=p>.</span><span class=nx>F1</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Invalid v: %v&#34;</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>continue</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>v</span> <span class=p>=</span> <span class=nf>process</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.</span><span class=nf>Call</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>v</span><span class=p>.</span><span class=nf>Send</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=不必要的-else>不必要的 else</h3><p>如果在 if 的两个分支中都设置了变量，则可以将其替换为单个 if。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>a</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>b</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>a</span> <span class=p>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>a</span> <span class=p>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>a</span> <span class=o>:=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>b</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>a</span> <span class=p>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=顶层变量声明>顶层变量声明</h3><p>在顶层，使用标准<code>var</code>关键字。请勿指定类型，除非它与表达式的类型不同。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_s</span> <span class=kt>string</span> <span class=p>=</span> <span class=nf>F</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>F</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span> <span class=k>return</span> <span class=s>&#34;A&#34;</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_s</span> <span class=p>=</span> <span class=nf>F</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// 由于 F 已经明确了返回一个字符串类型，因此我们没有必要显式指定_s 的类型
</span></span></span><span class=line><span class=cl><span class=c1>// 还是那种类型
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>F</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span> <span class=k>return</span> <span class=s>&#34;A&#34;</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>如果表达式的类型与所需的类型不完全匹配，请指定类型。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>myError</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>myError</span><span class=p>)</span> <span class=nf>Error</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span> <span class=k>return</span> <span class=s>&#34;error&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>F</span><span class=p>()</span> <span class=nx>myError</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>myError</span><span class=p>{}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_e</span> <span class=kt>error</span> <span class=p>=</span> <span class=nf>F</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// F 返回一个 myError 类型的实例，但是我们要 error 类型
</span></span></span></code></pre></td></tr></table></div></div><h3 id=对于未导出的顶层常量和变量使用_作为前缀>对于未导出的顶层常量和变量，使用_作为前缀</h3><p>在未导出的顶级<code>vars</code>和<code>consts</code>， 前面加上前缀_，以使它们在使用时明确表示它们是全局符号。</p><p>例外：未导出的错误值，应以<code>err</code>开头。</p><p>基本依据：顶级变量和常量具有包范围作用域。使用通用名称可能很容易在其他文件中意外使用错误的值。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// foo.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>defaultPort</span> <span class=p>=</span> <span class=mi>8080</span>
</span></span><span class=line><span class=cl>  <span class=nx>defaultUser</span> <span class=p>=</span> <span class=s>&#34;user&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// bar.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Bar</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>defaultPort</span> <span class=o>:=</span> <span class=mi>9090</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Default port&#34;</span><span class=p>,</span> <span class=nx>defaultPort</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// We will not see a compile error if the first line of
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Bar() is deleted.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// foo.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>_defaultPort</span> <span class=p>=</span> <span class=mi>8080</span>
</span></span><span class=line><span class=cl>  <span class=nx>_defaultUser</span> <span class=p>=</span> <span class=s>&#34;user&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=结构体中的嵌入>结构体中的嵌入</h3><p>嵌入式类型（例如 mutex）应位于结构体内的字段列表的顶部，并且必须有一个空行将嵌入式字段与常规字段分隔开。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Client</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>version</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>http</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Client</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>http</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>version</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>内嵌应该提供切实的好处，比如以语义上合适的方式添加或增强功能。
它应该在对用户没有任何不利影响的情况下使用（另请参见：<code>避免在公共结构中嵌入类型</code><a class=link href=#avoid-embedding-types-in-public-structs>Avoid Embedding Types in Public Structs</a>）。</p><p>嵌入 <strong>不应该</strong>:</p><ul><li>纯粹是为了美观或方便。</li><li>使外部类型更难构造或使用。</li><li>影响外部类型的零值。如果外部类型有一个有用的零值，则在嵌入内部类型之后应该仍然有一个有用的零值。</li><li>作为嵌入内部类型的副作用，从外部类型公开不相关的函数或字段。</li><li>公开未导出的类型。</li><li>影响外部类型的复制形式。</li><li>更改外部类型的API或类型语义。</li><li>嵌入内部类型的非规范形式。</li><li>公开外部类型的实现详细信息。</li><li>允许用户观察或控制类型内部。</li><li>通过包装的方式改变内部函数的一般行为，这种包装方式会给用户带来一些意料之外情况。</li></ul><p>简单地说，有意识地和有目的地嵌入。一种很好的测试体验是，
&ldquo;是否所有这些导出的内部方法/字段都将直接添加到外部类型&rdquo;
如果答案是<code>some</code>或<code>no</code>，不要嵌入内部类型-而是使用字段。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>A</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Bad: A.Lock() and A.Unlock() 现在可用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 不提供任何功能性好处，并允许用户控制有关A的内部细节。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>countingWriteCloser</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Good: Write() 在外层提供用于特定目的，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 并且委托工作到内部类型的Write()中。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>io</span><span class=p>.</span><span class=nx>WriteCloser</span>
</span></span><span class=line><span class=cl>    <span class=nx>count</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>countingWriteCloser</span><span class=p>)</span> <span class=nf>Write</span><span class=p>(</span><span class=nx>bs</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>w</span><span class=p>.</span><span class=nx>count</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>bs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>w</span><span class=p>.</span><span class=nx>WriteCloser</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>bs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Book</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Bad: 指针更改零值的有用性
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>io</span><span class=p>.</span><span class=nx>ReadWriter</span>
</span></span><span class=line><span class=cl>    <span class=c1>// other fields
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// later
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>b</span> <span class=nx>Book</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>  <span class=c1>// panic: nil pointer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>b</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>   <span class=c1>// panic: nil pointer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>b</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=o>...</span><span class=p>)</span> <span class=c1>// panic: nil pointer
</span></span></span></code></pre></td></tr></table></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Book</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Good: 有用的零值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>    <span class=c1>// other fields
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// later
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>b</span> <span class=nx>Book</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>  <span class=c1>// ok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>b</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>   <span class=c1>// ok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>b</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=o>...</span><span class=p>)</span> <span class=c1>// ok
</span></span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Client</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>    <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span>
</span></span><span class=line><span class=cl>    <span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>    <span class=nx>url</span><span class=p>.</span><span class=nx>URL</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Client</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mtx</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>    <span class=nx>wg</span>  <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span>
</span></span><span class=line><span class=cl>    <span class=nx>buf</span> <span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>    <span class=nx>url</span> <span class=nx>url</span><span class=p>.</span><span class=nx>URL</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=使用字段名初始化结构体>使用字段名初始化结构体</h3><p>初始化结构体时，应该指定字段名称。现在由 <a class=link href=https://golang.org/cmd/vet/ target=_blank rel=noopener><code>go vet</code></a> 强制执行。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>k</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span><span class=s>&#34;John&#34;</span><span class=p>,</span> <span class=s>&#34;Doe&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>k</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>FirstName</span><span class=p>:</span> <span class=s>&#34;John&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>LastName</span><span class=p>:</span> <span class=s>&#34;Doe&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Admin</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>例外：如果有 3 个或更少的字段，则可以在测试表中省略字段名称。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>tests</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>struct</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>op</span> <span class=nx>Operation</span>
</span></span><span class=line><span class=cl>  <span class=nx>want</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>Add</span><span class=p>,</span> <span class=s>&#34;add&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>Subtract</span><span class=p>,</span> <span class=s>&#34;subtract&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=本地变量声明>本地变量声明</h3><p>如果将变量明确设置为某个值，则应使用短变量声明形式 (<code>:=</code>)。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>s</span> <span class=p>=</span> <span class=s>&#34;foo&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>s</span> <span class=o>:=</span> <span class=s>&#34;foo&#34;</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>但是，在某些情况下，<code>var</code> 使用关键字时默认值会更清晰。例如，声明空切片。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>f</span><span class=p>(</span><span class=nx>list</span> <span class=p>[]</span><span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>filtered</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>list</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>v</span> <span class=p>&gt;</span> <span class=mi>10</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>filtered</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filtered</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>f</span><span class=p>(</span><span class=nx>list</span> <span class=p>[]</span><span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>filtered</span> <span class=p>[]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>list</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>v</span> <span class=p>&gt;</span> <span class=mi>10</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>filtered</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filtered</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=nil-是一个有效的-slice>nil 是一个有效的 slice</h3><p><code>nil</code> 是一个有效的长度为 0 的 slice，这意味着，</p><ul><li><p>您不应明确返回长度为零的切片。应该返回<code>nil</code> 来代替。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>x</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>x</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table></li><li><p>要检查切片是否为空，请始终使用<code>len(s) == 0</code>。而非 <code>nil</code>。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>isEmpty</span><span class=p>(</span><span class=nx>s</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>s</span> <span class=o>==</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>isEmpty</span><span class=p>(</span><span class=nx>s</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table></li><li><p>零值切片（用<code>var</code>声明的切片）可立即使用，无需调用<code>make()</code>创建。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>nums</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=c1>// or, nums := make([]int)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>add1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>nums</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nums</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>add2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>nums</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nums</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>nums</span> <span class=p>[]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>add1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>nums</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nums</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>add2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>nums</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nums</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table></li></ul><p>记住，虽然nil切片是有效的切片，但它不等于长度为0的切片（一个为nil，另一个不是），并且在不同的情况下（例如序列化），这两个切片的处理方式可能不同。</p><h3 id=缩小变量作用域>缩小变量作用域</h3><p>如果有可能，尽量缩小变量作用范围。除非它与 <a class=link href=#%e5%87%8f%e5%b0%91%e5%b5%8c%e5%a5%97>减少嵌套</a>的规则冲突。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>WriteFile</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=mo>0644</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>WriteFile</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=mo>0644</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>如果需要在 if 之外使用函数调用的结果，则不应尝试缩小范围。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=nx>name</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>err</span> <span class=p>=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=kc>nil</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=避免参数语义不明确avoid-naked-parameters>避免参数语义不明确(Avoid Naked Parameters)</h3><p>函数调用中的<code>意义不明确的参数</code>可能会损害可读性。当参数名称的含义不明显时，请为参数添加 C 样式注释 (<code>/* ... */</code>)</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// func printInfo(name string, isLocal, done bool)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nf>printInfo</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// func printInfo(name string, isLocal, done bool)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nf>printInfo</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=kc>true</span> <span class=cm>/* isLocal */</span><span class=p>,</span> <span class=kc>true</span> <span class=cm>/* done */</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>对于上面的示例代码，还有一种更好的处理方式是将上面的 <code>bool</code> 类型换成自定义类型。将来，该参数可以支持不仅仅局限于两个状态（true/false）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Region</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>UnknownRegion</span> <span class=nx>Region</span> <span class=p>=</span> <span class=kc>iota</span>
</span></span><span class=line><span class=cl>  <span class=nx>Local</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Status</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>StatusReady</span> <span class=nx>Status</span><span class=p>=</span> <span class=kc>iota</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>StatusDone</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Maybe we will have a StatusInProgress in the future.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>printInfo</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>region</span> <span class=nx>Region</span><span class=p>,</span> <span class=nx>status</span> <span class=nx>Status</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=使用原始字符串字面值避免转义>使用原始字符串字面值，避免转义</h3><p>Go 支持使用 <a class=link href=https://golang.org/ref/spec#raw_string_lit target=_blank rel=noopener>原始字符串字面值</a>，也就是 " ` " 来表示原生字符串，在需要转义的场景下，我们应该尽量使用这种方案来替换。</p><p>可以跨越多行并包含引号。使用这些字符串可以避免更难阅读的手工转义的字符串。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>wantError</span> <span class=o>:=</span> <span class=s>&#34;unknown name:\&#34;test\&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>wantError</span> <span class=o>:=</span> <span class=s>`unknown error:&#34;test&#34;`</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=初始化结构体>初始化结构体</h3><h4 id=使用字段名初始化结构>使用字段名初始化结构</h4><p>初始化结构时，几乎应该始终指定字段名。目前由<a class=link href=https://golang.org/cmd/vet/ target=_blank rel=noopener><code>go vet</code></a>强制执行。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>k</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span><span class=s>&#34;John&#34;</span><span class=p>,</span> <span class=s>&#34;Doe&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>k</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>FirstName</span><span class=p>:</span> <span class=s>&#34;John&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>LastName</span><span class=p>:</span> <span class=s>&#34;Doe&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Admin</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>例外：当有3个或更少的字段时，测试表中的字段名<em>may</em>可以省略。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>tests</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>struct</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>op</span> <span class=nx>Operation</span>
</span></span><span class=line><span class=cl>  <span class=nx>want</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>Add</span><span class=p>,</span> <span class=s>&#34;add&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>Subtract</span><span class=p>,</span> <span class=s>&#34;subtract&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=省略结构中的零值字段>省略结构中的零值字段</h4><p>初始化具有字段名的结构时，除非提供有意义的上下文，否则忽略值为零的字段。
也就是，让我们自动将这些设置为零值</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>FirstName</span><span class=p>:</span> <span class=s>&#34;John&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>LastName</span><span class=p>:</span> <span class=s>&#34;Doe&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>MiddleName</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Admin</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>FirstName</span><span class=p>:</span> <span class=s>&#34;John&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>LastName</span><span class=p>:</span> <span class=s>&#34;Doe&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>这有助于通过省略该上下文中的默认值来减少阅读的障碍。只指定有意义的值。</p><p>在字段名提供有意义上下文的地方包含零值。例如，<a class=link href=#%e8%a1%a8%e9%a9%b1%e5%8a%a8%e6%b5%8b%e8%af%95>表驱动测试</a> 中的测试用例可以受益于字段的名称，即使它们是零值的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>tests</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>struct</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>give</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>want</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>give</span><span class=p>:</span> <span class=s>&#34;0&#34;</span><span class=p>,</span> <span class=nx>want</span><span class=p>:</span> <span class=mi>0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=对零值结构使用-var>对零值结构使用 <code>var</code></h4><p>如果在声明中省略了结构的所有字段，请使用 <code>var</code> 声明结构。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>这将零值结构与那些具有类似于为[初始化 Maps]创建的,区别于非零值字段的结构区分开来，
并与我们更喜欢的<a class=link href=https://github.com/golang/go/wiki/CodeReviewComments#declaring-empty-slices target=_blank rel=noopener>declare empty slices</a>方式相匹配。</p><h4 id=初始化-struct-引用>初始化 Struct 引用</h4><p>在初始化结构引用时，请使用<code>&amp;T{}</code>代替<code>new(T)</code>，以使其与结构体初始化一致。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>sval</span> <span class=o>:=</span> <span class=nx>T</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;foo&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// inconsistent
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>sptr</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>T</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>sptr</span><span class=p>.</span><span class=nx>Name</span> <span class=p>=</span> <span class=s>&#34;bar&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>sval</span> <span class=o>:=</span> <span class=nx>T</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;foo&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>sptr</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>T</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bar&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=初始化-maps>初始化 Maps</h3><p>对于空 map 请使用 <code>make(..)</code> 初始化， 并且 map 是通过编程方式填充的。
这使得 map 初始化在表现上不同于声明，并且它还可以方便地在 make 后添加大小提示。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// m1 读写安全;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// m2 在写入时会 panic
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>m1</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>T1</span><span class=p>]</span><span class=nx>T2</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>m2</span> <span class=kd>map</span><span class=p>[</span><span class=nx>T1</span><span class=p>]</span><span class=nx>T2</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// m1 读写安全;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// m2 在写入时会 panic
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>m1</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>T1</span><span class=p>]</span><span class=nx>T2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>m2</span> <span class=kd>map</span><span class=p>[</span><span class=nx>T1</span><span class=p>]</span><span class=nx>T2</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><p>声明和初始化看起来非常相似的。</p></td><td><p>声明和初始化看起来差别非常大。</p></td></tr></tbody></table><p>在尽可能的情况下，请在初始化时提供 map 容量大小，详细请看 <a class=link href=#%e6%8c%87%e5%ae%9aMap%e5%ae%b9%e9%87%8f%e6%8f%90%e7%a4%ba>指定Map容量提示</a>。</p><p>另外，如果 map 包含固定的元素列表，则使用 map literals(map 初始化列表) 初始化映射。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>T1</span><span class=p>]</span><span class=nx>T2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>[</span><span class=nx>k1</span><span class=p>]</span> <span class=p>=</span> <span class=nx>v1</span>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>[</span><span class=nx>k2</span><span class=p>]</span> <span class=p>=</span> <span class=nx>v2</span>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>[</span><span class=nx>k3</span><span class=p>]</span> <span class=p>=</span> <span class=nx>v3</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>T1</span><span class=p>]</span><span class=nx>T2</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>k1</span><span class=p>:</span> <span class=nx>v1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>k2</span><span class=p>:</span> <span class=nx>v2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>k3</span><span class=p>:</span> <span class=nx>v3</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>基本准则是：在初始化时使用 map 初始化列表 来添加一组固定的元素。否则使用 <code>make</code> (如果可以，请尽量指定 map 容量)。</p><h3 id=字符串-string-format>字符串 string format</h3><p>如果你在函数外声明<code>Printf</code>-style 函数的格式字符串，请将其设置为<code>const</code>常量。</p><p>这有助于<code>go vet</code>对格式字符串执行静态分析。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>msg</span> <span class=o>:=</span> <span class=s>&#34;unexpected values %v, %v\n&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=nx>msg</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=nx>msg</span> <span class=p>=</span> <span class=s>&#34;unexpected values %v, %v\n&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=nx>msg</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><h3 id=命名-printf-样式的函数>命名 Printf 样式的函数</h3><p>声明<code>Printf</code>-style 函数时，请确保<code>go vet</code>可以检测到它并检查格式字符串。</p><p>这意味着您应尽可能使用预定义的<code>Printf</code>-style 函数名称。<code>go vet</code>将默认检查这些。有关更多信息，请参见 <a class=link href=https://golang.org/cmd/vet/#hdr-Printf_family target=_blank rel=noopener>Printf 系列</a>。</p><p>如果不能使用预定义的名称，请以 f 结束选择的名称：<code>Wrapf</code>，而不是<code>Wrap</code>。<code>go vet</code>可以要求检查特定的 Printf 样式名称，但名称必须以<code>f</code>结尾。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go vet -printfuncs<span class=o>=</span>wrapf,statusf
</span></span></code></pre></td></tr></table></div></div><p>另请参阅 <a class=link href=https://kuzminva.wordpress.com/2017/11/07/go-vet-printf-family-check/ target=_blank rel=noopener>go vet: Printf family check</a>.</p><h2 id=编程模式>编程模式</h2><h3 id=表驱动测试>表驱动测试</h3><p>当测试逻辑是重复的时候，通过 <a class=link href=https://blog.golang.org/subtests target=_blank rel=noopener>subtests</a> 使用 table 驱动的方式编写 case 代码看上去会更简洁。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// func TestSplitHostPort(t *testing.T)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>host</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>SplitHostPort</span><span class=p>(</span><span class=s>&#34;192.0.2.0:8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>require</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=s>&#34;192.0.2.0&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=s>&#34;8000&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>host</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>SplitHostPort</span><span class=p>(</span><span class=s>&#34;192.0.2.0:http&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>require</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=s>&#34;192.0.2.0&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=s>&#34;http&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>host</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>SplitHostPort</span><span class=p>(</span><span class=s>&#34;:8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>require</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=s>&#34;8000&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>host</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>SplitHostPort</span><span class=p>(</span><span class=s>&#34;1:8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>require</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=s>&#34;1&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=s>&#34;8&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// func TestSplitHostPort(t *testing.T)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>tests</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>struct</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>give</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>wantHost</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>wantPort</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>give</span><span class=p>:</span>     <span class=s>&#34;192.0.2.0:8000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>wantHost</span><span class=p>:</span> <span class=s>&#34;192.0.2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>wantPort</span><span class=p>:</span> <span class=s>&#34;8000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>give</span><span class=p>:</span>     <span class=s>&#34;192.0.2.0:http&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>wantHost</span><span class=p>:</span> <span class=s>&#34;192.0.2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>wantPort</span><span class=p>:</span> <span class=s>&#34;http&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>give</span><span class=p>:</span>     <span class=s>&#34;:8000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>wantHost</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>wantPort</span><span class=p>:</span> <span class=s>&#34;8000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>give</span><span class=p>:</span>     <span class=s>&#34;1:8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>wantHost</span><span class=p>:</span> <span class=s>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>wantPort</span><span class=p>:</span> <span class=s>&#34;8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>tt</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>tests</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>t</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>tt</span><span class=p>.</span><span class=nx>give</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>host</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>SplitHostPort</span><span class=p>(</span><span class=nx>tt</span><span class=p>.</span><span class=nx>give</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>require</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>tt</span><span class=p>.</span><span class=nx>wantHost</span><span class=p>,</span> <span class=nx>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>tt</span><span class=p>.</span><span class=nx>wantPort</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>很明显，使用 test table 的方式在代码逻辑扩展的时候，比如新增 test case，都会显得更加的清晰。</p><p>我们遵循这样的约定：将结构体切片称为<code>tests</code>。 每个测试用例称为<code>tt</code>。此外，我们鼓励使用<code>give</code>和<code>want</code>前缀说明每个测试用例的输入和输出值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>tests</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>struct</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>give</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>wantHost</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>wantPort</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>tt</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>tests</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=功能选项>功能选项</h3><p>功能选项是一种模式，您可以在其中声明一个不透明 Option 类型，该类型在某些内部结构中记录信息。您接受这些选项的可变编号，并根据内部结构上的选项记录的全部信息采取行动。</p><p>将此模式用于您需要扩展的构造函数和其他公共 API 中的可选参数，尤其是在这些功能上已经具有三个或更多参数的情况下。</p><div class=table-wrapper><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// package db
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Open</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>addr</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>cache</span> <span class=kt>bool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span> <span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Connection</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></td><td><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// package db
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Option</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>WithCache</span><span class=p>(</span><span class=nx>c</span> <span class=kt>bool</span><span class=p>)</span> <span class=nx>Option</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>WithLogger</span><span class=p>(</span><span class=nx>log</span> <span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span><span class=p>)</span> <span class=nx>Option</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Open creates a connection.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Open</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>addr</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Connection</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></td></tr><tr><td><p>必须始终提供缓存和记录器参数，即使用户希望使用默认值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nx>DefaultCache</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewNop</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nx>DefaultCache</span><span class=p>,</span> <span class=nx>log</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* cache */</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewNop</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* cache */</span><span class=p>,</span> <span class=nx>log</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td><td><p>只有在需要时才提供选项。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nf>WithLogger</span><span class=p>(</span><span class=nx>log</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>db</span><span class=p>.</span><span class=nf>WithCache</span><span class=p>(</span><span class=kc>false</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>addr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nf>WithCache</span><span class=p>(</span><span class=kc>false</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nf>WithLogger</span><span class=p>(</span><span class=nx>log</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></td></tr></tbody></table><p>Our suggested way of implementing this pattern is with an <code>Option</code> interface
that holds an unexported method, recording options on an unexported <code>options</code>
struct.</p><p>我们建议实现此模式的方法是使用一个 <code>Option</code> 接口，该接口保存一个未导出的方法，在一个未导出的 <code>options</code> 结构上记录选项。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>options</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>cache</span>  <span class=kt>bool</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span> <span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Option</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>apply</span><span class=p>(</span><span class=o>*</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>cacheOption</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=nx>cacheOption</span><span class=p>)</span> <span class=nf>apply</span><span class=p>(</span><span class=nx>opts</span> <span class=o>*</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>opts</span><span class=p>.</span><span class=nx>cache</span> <span class=p>=</span> <span class=nb>bool</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>WithCache</span><span class=p>(</span><span class=nx>c</span> <span class=kt>bool</span><span class=p>)</span> <span class=nx>Option</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>cacheOption</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>loggerOption</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Log</span> <span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=nx>loggerOption</span><span class=p>)</span> <span class=nf>apply</span><span class=p>(</span><span class=nx>opts</span> <span class=o>*</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>opts</span><span class=p>.</span><span class=nx>logger</span> <span class=p>=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>Log</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>WithLogger</span><span class=p>(</span><span class=nx>log</span> <span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span><span class=p>)</span> <span class=nx>Option</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loggerOption</span><span class=p>{</span><span class=nx>Log</span><span class=p>:</span> <span class=nx>log</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Open creates a connection.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Open</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>addr</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Connection</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span> <span class=o>:=</span> <span class=nx>options</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cache</span><span class=p>:</span>  <span class=nx>defaultCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>:</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewNop</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>o</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>opts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>o</span><span class=p>.</span><span class=nf>apply</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意: 还有一种使用闭包实现这个模式的方法，但是我们相信上面的模式为作者提供了更多的灵活性，并且更容易对用户进行调试和测试。特别是，在不可能进行比较的情况下它允许在测试和模拟中对选项进行比较。此外，它还允许选项实现其他接口，包括 <code>fmt.Stringer</code>，允许用户读取选项的字符串表示形式。</p><p>还可以参考下面资料：</p><ul><li><p><a class=link href=https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html target=_blank rel=noopener>Self-referential functions and the design of options</a></p></li><li><p><a class=link href=https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis target=_blank rel=noopener>Functional options for friendly APIs</a></p></li></ul><h2 id=linting>Linting</h2><p>比任何 &ldquo;blessed&rdquo; linter 集更重要的是，lint在一个代码库中始终保持一致。</p><p>我们建议至少使用以下linters，因为我认为它们有助于发现最常见的问题，并在不需要规定的情况下为代码质量建立一个高标准：</p><ul><li><p><a class=link href=https://github.com/kisielk/errcheck target=_blank rel=noopener>errcheck</a> 以确保错误得到处理</p></li><li><p><a class=link href=https://godoc.org/golang.org/x/tools/cmd/goimports target=_blank rel=noopener>goimports</a> 格式化代码和管理 imports</p></li><li><p><a class=link href=https://github.com/golang/lint target=_blank rel=noopener>golint</a> 指出常见的文体错误</p></li><li><p><a class=link href=https://golang.org/cmd/vet/ target=_blank rel=noopener>govet</a> 分析代码中的常见错误</p></li><li><p><a class=link href=https://staticcheck.io/ target=_blank rel=noopener>staticcheck</a> 各种静态分析检查</p></li></ul><h3 id=lint-runners>Lint Runners</h3><p>我们推荐 <a class=link href=https://github.com/golangci/golangci-lint target=_blank rel=noopener>golangci-lint</a> 作为go-to lint的运行程序，这主要是因为它在较大的代码库中的性能以及能够同时配置和使用许多规范。这个repo有一个示例配置文件<a class=link href=https://github.com/uber-go/guide/blob/master/.golangci.yml target=_blank rel=noopener>.golangci.yml</a>和推荐的linter设置。</p><p>golangci-lint 有<a class=link href=https://golangci-lint.run/usage/linters/ target=_blank rel=noopener>various-linters</a>可供使用。建议将上述linters作为基本set，我们鼓励团队添加对他们的项目有意义的任何附加linters。</p><h2 id=stargazers-over-time>Stargazers over time</h2><p><a class=link href=https://starchart.cc/xxjwxc/uber_go_guide_cn target=_blank rel=noopener><img src=https://starchart.cc/xxjwxc/uber_go_guide_cn.svg loading=lazy alt="Stargazers over time"></a></p></section><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0}),document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll("pre code.language-mermaid");e.forEach(function(e){var n,t=document.createElement("div");t.className="mermaid",t.innerHTML=e.textContent,n=e.parentElement,n.parentNode.replaceChild(t,n)})})</script><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/blog/p/yamux-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/><div class=article-details><h2 class=article-title>yamux 流程分析</h2></div></a></article><article><a href=/blog/p/mutlistream-select-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/><div class=article-details><h2 class=article-title>mutlistream-select 流程分析</h2></div></a></article><article><a href=/blog/p/%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89-ttl-udp-%E5%8C%85%E5%8F%91%E9%80%81/><div class=article-details><h2 class=article-title>实现自定义 TTL UDP 包发送</h2></div></a></article><article><a href=/blog/p/go-%E9%98%B2%E8%B8%A9%E5%9D%91%E7%BC%96%E7%A8%8B%E6%8C%87%E5%8D%97/><div class=article-details><h2 class=article-title>Go 防踩坑编程指南</h2></div></a></article><article><a href=/blog/p/%E6%AF%94%E8%BE%83%E9%AA%9A%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BB%A3%E7%A0%81/><div class=article-details><h2 class=article-title>比较骚的一些代码</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Wlynxg's Blog</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>